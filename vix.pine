//@version=6
indicator("VIX Term Structure Pro [v7.8]", overlay=false, max_lines_count=500, calc_bars_count=1000)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    VIX Term Structure Pro v7.8 ä½¿ç”¨æŒ‡å—                      â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Š ä»ªè¡¨ç›˜æŒ‡æ ‡è§£è¯»                                                           â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ æŒ‡æ ‡           â”‚ çœ‹æ¶¨ä¿¡å· ğŸŸ¢              â”‚ çœ‹è·Œä¿¡å· ğŸ”´                     â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ Overall Bias   â”‚ STRONG BUY / BUY DIP    â”‚ STRONG SELL / SELL/HEDGE       â•‘
// â•‘ AI Score       â”‚ â‰¥ 5 (æåº¦ææ…Œ)           â”‚ â‰¤ -5 (æåº¦è´ªå©ª)                 â•‘
// â•‘ Market Trend   â”‚ ğŸŸ¢SPX ğŸŸ¢NDX ğŸŸ¢RUT       â”‚ ğŸ”´SPX ğŸ”´NDX ğŸ”´RUT               â•‘
// â•‘ VIX Regime     â”‚ LOW VOL (<15)           â”‚ HIGH VOL (>25)                 â•‘
// â•‘ Term Struct Z  â”‚ < -2.0 (ææ…Œ)           â”‚ > 2.0 (è´ªå©ª)                    â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ ğŸ’¡ çŠ¶æ€æç¤ºè¯´æ˜ (Status)                                                    â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ WAIT (ç­‰å¾…)    â”‚ ğŸŸ¡ ä¹°å…¥ä¾§ã€‚è¯„åˆ†è¾¾æ ‡ä½†è¢«è¿‡æ»¤ï¼ˆå¦‚é«˜æ³¢åŠ¨æˆ–åŠ¨é‡æœªç¡®è®¤ï¼‰ã€‚        â•‘
// â•‘                â”‚ å«ä¹‰ï¼šä¸è¦æ€¥äºè¿›åœºï¼Œç­‰å¾…æ›´å¥½çš„æ—¶æœºã€‚                        â•‘
// â•‘ HOLD (æŒæœ‰)    â”‚ ğŸŸ  å–å‡ºä¾§ã€‚è¯„åˆ†è¾¾æ ‡ä½†è¢«è¿‡æ»¤ï¼ˆå¦‚ä½æ³¢åŠ¨æˆ–åŠ¨é‡æœªç¡®è®¤ï¼‰ã€‚        â•‘
// â•‘                â”‚ å«ä¹‰ï¼šä¸è¦æ€¥äºå–å‡º/å¯¹å†²ï¼Œç»§ç»­æŒæœ‰ä»“ä½ã€‚                      â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Œ v7.8 æ–°å¢åŠŸèƒ½ (Dashboard Redesign)                                       â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ ğŸ¨ å…¨æ–°ä»ªè¡¨ç›˜    â”‚ Mobile/Full åŒæ¨¡å¼ï¼Œæ·±è‰²ä¸»é¢˜ï¼Œåˆ†ç»„å¸ƒå±€                    â•‘
// â•‘ ğŸ“Š è¿›åº¦æ¡æ˜¾ç¤º    â”‚ Score å¯è§†åŒ–è¿›åº¦æ¡ (â–ˆâ–‘)                                  â•‘
// â•‘ ğŸ›¡ï¸ å®ç›˜å®‰å…¨æ¨¡å¼  â”‚ é»˜è®¤å¼€å¯ï¼Œæ— é‡ç»˜ (lookahead_off)                         â•‘
// â•‘ â¬†ï¸ è·¨Kçº¿å‡çº§æŠ¥è­¦  â”‚ ä¿¡å·ç­‰çº§å‡çº§æ—¶è§¦å‘æ–°è­¦æŠ¥ (DIPâ†’STRONGâ†’CRASH)              â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ========== è¯„åˆ†å‡½æ•°å®šä¹‰ (æ¨¡å—åŒ–) ==========
calc_z_score_points(z_val, mid, strong) =>
    z_val < -strong ? 4 : z_val < -mid ? 2 : z_val > strong ? -4 : z_val > mid ? -2 : 0

calc_contango_points(contango) =>
    contango < 0 ? 2 : contango > 10 ? -1 : 0

calc_basis_points(is_panic, is_calm) =>
    is_panic ? 2 : is_calm ? -1 : 0

calc_skew_points(is_high, is_low) =>
    is_high ? -3 : is_low ? 1 : 0

calc_pcr_points(pcr_val) =>
    na(pcr_val) ? 0 : pcr_val > 1.20 ? 2 : pcr_val < 0.70 ? -2 : 0

calc_vvix_points(vvix_val, use_vvix) =>
    not use_vvix or na(vvix_val) ? 0 : vvix_val > 130 ? 1 : vvix_val < 80 ? -1 : 0

// ========== v7.8: è¿›åº¦æ¡ç”Ÿæˆå‡½æ•° ==========
// ç”Ÿæˆ Score è¿›åº¦æ¡ (-10 åˆ° +10 èŒƒå›´ï¼Œ10æ ¼)
f_score_bar(score_val) =>
    clamped = math.max(-10.0, math.min(10.0, score_val))
    filled = math.round((clamped + 10.0) / 20.0 * 10.0)
    string bar = ""
    for i = 0 to 9
        bar := bar + (i < filled ? "â–ˆ" : "â–‘")
    bar

// ========== KAMA è‡ªå®šä¹‰å®ç° (Kaufman Adaptive Moving Average) ==========
// ç”±äº ta.kama() åœ¨æŸäº›ç¯å¢ƒä¸å¯ç”¨ï¼Œæ‰‹åŠ¨å®ç°
calc_kama(src, length, fastLen, slowLen) =>
    // è®¡ç®—æ•ˆç‡æ¯”ç‡ (Efficiency Ratio)
    change_sum = math.abs(src - src[length])
    volatility = math.sum(math.abs(src - src[1]), length)
    er = volatility != 0 ? change_sum / volatility : 0.0
    // è®¡ç®—å¹³æ»‘å¸¸æ•° (Smoothing Constant)
    fast_sc = 2.0 / (fastLen + 1)
    slow_sc = 2.0 / (slowLen + 1)
    sc = math.pow(er * (fast_sc - slow_sc) + slow_sc, 2)
    // è®¡ç®— KAMA (é€’å½’)
    var float kama = na
    kama := na(kama[1]) ? src : kama[1] + sc * (src - kama[1])
    kama

// ========== 1. å‚æ•°è®¾ç½® ==========

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“¡ æ•°æ®æºè®¾ç½® (Data Sources)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_data = "ğŸ“¡ Data Sources"
trading_safe_mode = input.bool(true, "ğŸ›¡ï¸ Trading Safe Mode (Recommended)", group=grp_data, tooltip="ON: å®ç›˜å®‰å…¨æ¨¡å¼ Trading-safe (æ— é‡ç»˜ no repaint, é»˜è®¤æ¨è recommended)\nOFF: é¢„è§ˆæ¨¡å¼ Preview mode (ç›˜ä¸­å®æ—¶æ›´æ–°ä½†å†å²å¯èƒ½é‡ç»˜ intraday updates but history may repaint)")
backtest_mode = input.bool(false, "ğŸ”¬ Legacy Backtest Mode", group=grp_data, tooltip="âš ï¸ å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ Trading Safe Mode\nDeprecated: Use Trading Safe Mode instead\nä¿ç•™ä»…ä¾›å‘åå…¼å®¹ Kept for backward compatibility")
sym_vix_input = input.symbol("CBOE:VIX", "VIX Symbol", group=grp_data, tooltip="VIXæ•°æ®æº VIX data source\né»˜è®¤ Default: CBOE:VIX")
vix_timeframe = input.string("Daily", "VIX Timeframe", options=["Daily", "Chart"], group=grp_data, tooltip="Daily: æ—¥çº¿æ”¶ç›˜ä»· daily close (ç¨³å®š stable)\nChart: è·Ÿéšå›¾è¡¨ follow chart (å®æ—¶ real-time)")
sym_pcr_input = input.symbol("INDEX:CPCI", "Put/Call Ratio Symbol", group=grp_data, tooltip="çœ‹è·Œ/çœ‹æ¶¨æ¯”ç‡ Put/Call Ratio\né»˜è®¤ Default: INDEX:CPCI (æŒ‡æ•°æœŸæƒ Index options)")
manual_trend_src = input.symbol("SP:SPX", "Manual Trend Source", group=grp_data, tooltip="æ‰‹åŠ¨è¶‹åŠ¿æº Manual trend source\nä»…å½“è‡ªåŠ¨æ£€æµ‹å…³é—­æ—¶ä½¿ç”¨ Only used when Auto-Detect is OFF")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš ï¸ ç­–ç•¥æ¨¡å¼ (Strategy Mode) - æ ¸å¿ƒè®¾ç½®
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_strategy = "âš ï¸ Strategy Mode (æ ¸å¿ƒè®¾ç½®)"
sens_mode = input.string("Low (Trend/Safe)", "Signal Sensitivity", options=["High (Scalping)", "Normal (Swing)", "Low (Trend/Safe)"], group=grp_strategy, tooltip="High: é«˜æ•æ„Ÿåº¦ Sensitive (çŸ­çº¿ scalping)\nNormal: å¹³è¡¡ Balanced (æ³¢æ®µ swing)\nLow: ä¿å®ˆ Conservative (è¶‹åŠ¿ trend)")
use_trend_filter = input.bool(true, "ğŸ›¡ï¸ Market Trend Filter", group=grp_strategy, tooltip="ON: ç†Šå¸‚è¿‡æ»¤ BUY DIP Filter in bear market\nä»… STRONG BUY ä¸å—é™åˆ¶ Only STRONG BUY allowed")
auto_detect_index = input.bool(true, "Auto-Detect Index (Based on Chart)", group=grp_strategy, tooltip="ON: è‡ªåŠ¨æ£€æµ‹ Auto-detect (QQQâ†’NDX, å…¶ä»–â†’SPX)\nOFF: ä½¿ç”¨æ‰‹åŠ¨è¶‹åŠ¿æº Use manual trend source")

// è‡ªé€‚åº”è¶‹åŠ¿è¿‡æ»¤å™¨è®¾ç½® (v7.1 æ–°å¢)
trend_ma_mode = input.string("Adaptive", "Trend MA Mode", options=["Fixed", "Adaptive", "KAMA"], group=grp_strategy, tooltip="Fixed: å›ºå®šå‡çº¿ Fixed MA\nAdaptive: æ³¢åŠ¨è‡ªé€‚åº” Vol-adaptive\nKAMA: æ•ˆç‡è‡ªé€‚åº” Efficiency-adaptive")
trend_ma_type = input.string("SMA", "â””â”€ Fixed MA Type", options=["SMA", "EMA"], group=grp_strategy, tooltip="ä»…Fixedæ¨¡å¼ For Fixed mode only\nSMA: ç¨³å®š Stable / EMA: çµæ• Responsive")
trend_ma_length_high = input.int(100, "â””â”€ Adaptive Length (High Vol)", minval=20, maxval=200, group=grp_strategy, tooltip="é«˜æ³¢åŠ¨æœŸå‡çº¿é•¿åº¦ MA length for high vol\næ›´çŸ­=æ›´æ•æ„Ÿ Shorter=more sensitive")
trend_ma_length_low = input.int(200, "â””â”€ Adaptive/Fixed Length (Low Vol)", minval=100, maxval=500, group=grp_strategy, tooltip="ä½æ³¢åŠ¨æœŸ/Fixedé»˜è®¤é•¿åº¦ MA length for low vol/Fixed\næ›´é•¿=æ›´å¹³æ»‘ Longer=smoother")
kama_length = input.int(21, "â””â”€ KAMA Length", minval=5, maxval=50, group=grp_strategy, tooltip="KAMAè®¡ç®—å‘¨æœŸ KAMA lookback\nè¾ƒçŸ­=ååº”æ›´å¿« Shorter=faster response")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ¯ ä¿¡å·ç¡®è®¤ (Signal Confirmation)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_confirm = "ğŸ¯ Signal Confirmation"
use_confirmed_signals = input.bool(false, "ğŸ”’ Confirmed Signals Only", group=grp_confirm, tooltip="ON: Kçº¿æ”¶ç›˜ç¡®è®¤ Confirm on bar close (ç¨³å®š stable)\nOFF: å®æ—¶ä¿¡å· Real-time (ç›˜ä¸­æŠ¥è­¦ intraday alerts)")
use_momentum_confirm = input.bool(true, "Use Momentum Confirmation", group=grp_confirm, tooltip="å¯ç”¨åŠ¨é‡ç¡®è®¤ Enable momentum confirmation\néœ€è¦Z-Scoreæœ‰æ–¹å‘æ€§å˜åŒ– Require Z-Score direction")
momentum_bars = input.int(3, "Momentum Lookback Bars", minval=1, maxval=10, group=grp_confirm, tooltip="åŠ¨é‡è®¡ç®—å‘¨æœŸ Momentum lookback period")
z_momentum_neutral_zone = input.float(0.05, "Z Momentum Neutral Zone", minval=0.01, maxval=0.2, step=0.01, group=grp_confirm, tooltip="ZåŠ¨é‡ä¸­æ€§åŒº Z momentum neutral zone\nè¿‡æ»¤å™ªéŸ³ Filter noise")
use_mtf_confirm = input.bool(false, "Use Weekly MTF Confirmation", group=grp_confirm, tooltip="å‘¨çº¿ç¡®è®¤ Weekly confirmation\néœ€è¦å‘¨çº¿Zæ–¹å‘ä¸€è‡´ Require weekly Z alignment")
signal_display_cooldown = input.int(5, "Signal Display Cooldown (Bars)", minval=1, maxval=20, group=grp_confirm, tooltip="ä¿¡å·å†·å´é—´éš” Signal cooldown (bars)\né¿å…åŒç±»ä¿¡å·é¢‘ç¹è§¦å‘ Prevent frequent triggers")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ¨ å›¾è¡¨æ ·å¼ (Chart Style)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_chart = "ğŸ¨ Chart Style"
show_z      = input.bool(true, "Show Term Struct Z-Score", group=grp_chart, tooltip="æ˜¾ç¤ºæœŸé™ç»“æ„Zå€¼ Show term structure Z-Score")
show_skew   = input.bool(false, "Show Scaled SKEW Line", group=grp_chart, tooltip="æ˜¾ç¤ºSKEWçº¿ Show SKEW line (ç¼©æ”¾æ˜¾ç¤º scaled)")
show_volume = input.bool(true, "Show Smart Volume", group=grp_chart, tooltip="æ˜¾ç¤ºæ™ºèƒ½æˆäº¤é‡ Show smart volume bars")
mid_line_color = input.color(color.yellow, "Â±1 Line Color", group=grp_chart, tooltip="Â±1çº¿é¢œè‰² Â±1 line color")
mid_line_style = input.string("Dashed", "Â±1 Line Style", options=["Solid", "Dashed", "Dotted"], group=grp_chart, tooltip="Â±1çº¿æ ·å¼ Â±1 line style")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ ä»ªè¡¨ç›˜è®¾ç½® (Dashboard) - v7.8 é‡æ–°è®¾è®¡
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_dashboard = "ğŸ“‹ Dashboard"
show_table  = input.bool(true, "Show Dashboard", group=grp_dashboard, tooltip="æ˜¾ç¤ºä»ªè¡¨ç›˜ Show dashboard panel")
panel_mode  = input.string("Full", "Dashboard Mode", options=["Full", "Mobile"], group=grp_dashboard, tooltip="Full: å®Œæ•´åˆ†ç»„å¸ƒå±€ Grouped layout with progress bar\nMobile: æç®€2è¡Œ Minimal 2 rows for mobile")
table_position = input.string("Top Right", "Dashboard Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left", "Top Center", "Bottom Center"], group=grp_dashboard, tooltip="ä»ªè¡¨ç›˜ä½ç½® Dashboard position")
table_size  = input.string("Normal", "Dashboard Text Size", options=["Small", "Normal", "Large"], group=grp_dashboard, tooltip="æ–‡å­—å¤§å° Text size")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Š ç»Ÿè®¡ä¸è­¦æŠ¥ (Statistics & Alerts)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_stats = "ğŸ“Š Statistics & Alerts"
show_signal_stats = input.bool(true, "Show Signal Statistics", group=grp_stats, tooltip="æ˜¾ç¤ºä¿¡å·ç»Ÿè®¡ Show signal statistics")
stats_lookback_years = input.int(3, "Stats Lookback (Years)", minval=1, maxval=20, group=grp_stats, tooltip="ç»Ÿè®¡å›æº¯å¹´æ•° Stats lookback years\nä»…ç»Ÿè®¡æ­¤èŒƒå›´å†…ä¿¡å· Only count signals within range")
crash_return_bars = input.int(40, "ğŸš¨ CRASH Return Period (Bars)", minval=10, maxval=60, group=grp_stats, tooltip="CRASHä¿¡å·æ”¶ç›Šå‘¨æœŸ CRASH return period\nçº¦2ä¸ªæœˆ ~2 months")
strong_return_bars = input.int(20, "ğŸŸ¢ STRONG Return Period (Bars)", minval=10, maxval=40, group=grp_stats, tooltip="STRONGä¿¡å·æ”¶ç›Šå‘¨æœŸ STRONG return period\nçº¦1ä¸ªæœˆ ~1 month")
dip_return_bars = input.int(10, "ğŸŸ¡ DIP Return Period (Bars)", minval=5, maxval=20, group=grp_stats, tooltip="DIPä¿¡å·æ”¶ç›Šå‘¨æœŸ DIP return period\nçº¦2å‘¨ ~2 weeks")
enable_smart_alert = input.bool(true, "ğŸ”” Smart Alert", group=grp_stats, tooltip="å¯ç”¨æ™ºèƒ½è­¦æŠ¥ Enable Smart Alert\nå•æ¡æ¶ˆæ¯æ±‡æ€»æ‰€æœ‰ä¿¡å· Aggregated signal message")
alert_cooldown_base = input.int(5, "Alert Cooldown Base (Bars)", minval=1, maxval=20, group=grp_stats, tooltip="åŸºç¡€å†·å´é—´éš” Base cooldown\né«˜æ³¢åŠ¨æœŸå‡åŠ Halved in high vol")
alert_freq_mode = input.string("Real-time", "â””â”€ Alert Frequency", options=["Once Per Bar", "Real-time"], group=grp_stats, tooltip="Once Per Bar: æ¯Kçº¿æœ€å¤šä¸€æ¬¡ Max once per bar\nReal-time: å®æ—¶è§¦å‘ Trigger on every condition")
alert_freq = alert_freq_mode == "Real-time" ? alert.freq_all : alert.freq_once_per_bar

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš™ï¸ é«˜çº§è®¾ç½® (Advanced Settings)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_advanced = "âš™ï¸ Advanced Settings"

// VIX Regime é˜ˆå€¼
vix_low_thresh = input.float(15.0, "VIX Low Vol Threshold", minval=10, maxval=20, group=grp_advanced, tooltip="ä½æ³¢åŠ¨é˜ˆå€¼ Low vol threshold\nä½äºæ­¤å€¼=LOW VOL Below=LOW VOL")
vix_high_thresh = input.float(25.0, "VIX High Vol Threshold", minval=20, maxval=40, group=grp_advanced, tooltip="é«˜æ³¢åŠ¨é˜ˆå€¼ High vol threshold\né«˜äºæ­¤å€¼=HIGH VOL Above=HIGH VOL")

// è‡ªé€‚åº”é˜ˆå€¼
use_adaptive_thresholds = input.bool(true, "Use Adaptive Thresholds", group=grp_advanced, tooltip="è‡ªé€‚åº”é˜ˆå€¼ Adaptive thresholds\nä½¿ç”¨ç™¾åˆ†ä½åŠ¨æ€é˜ˆå€¼ Use percentile-based thresholds")
adapt_lookback = input.int(252, "Adaptive Lookback Period", minval=50, maxval=500, group=grp_advanced, tooltip="è‡ªé€‚åº”å›æº¯å‘¨æœŸ Adaptive lookback\n252=1å¹´ 1 year")

// Z-Score è®¡ç®—
use_adaptive = input.bool(true, "Use Adaptive Lookback (Z-Score)", group=grp_advanced, tooltip="Z-Scoreè‡ªé€‚åº”å›æº¯ Adaptive Z lookback\né«˜æ³¢åŠ¨æœŸç”¨çŸ­å‘¨æœŸ Shorter in high vol")
len_low      = input.int(252, "Lookback (Low Vol)", minval=50, group=grp_advanced, tooltip="ä½æ³¢åŠ¨å›æº¯ Low vol lookback\n252=1å¹´ 1 year")
len_high     = input.int(126, "Lookback (High Vol)", minval=20, group=grp_advanced, tooltip="é«˜æ³¢åŠ¨å›æº¯ High vol lookback\n126=åŠå¹´ 6 months")
vol_thresh   = input.float(20.0, "Vol Regime Threshold", minval=10, group=grp_advanced, tooltip="æ³¢åŠ¨åŒºé—´é˜ˆå€¼ Vol regime threshold\nVIXé«˜äºæ­¤å€¼=é«˜æ³¢åŠ¨æœŸ Above=high vol")

// SKEW è®¾ç½®
skew_mode    = input.string("Relative (Z-Score)", "SKEW Logic Mode", options=["Relative (Z-Score)", "Percentile (Adaptive)", "Absolute (>140)"], group=grp_advanced, tooltip="SKEWåˆ¤æ–­æ¨¡å¼ SKEW logic mode\nZ-Score: ç›¸å¯¹æ ‡å‡†å·® / Percentile: ç™¾åˆ†ä½ / Absolute: å›ºå®šå€¼")
skew_len     = input.int(126, "SKEW Lookback Period", minval=20, group=grp_advanced, tooltip="SKEWå›æº¯å‘¨æœŸ SKEW lookback\n126=åŠå¹´ 6 months")

// æˆäº¤é‡è®¾ç½®
vol_avg_len  = input.int(20, "Volume Avg Length", minval=5, group=grp_advanced, tooltip="æˆäº¤é‡å‡çº¿é•¿åº¦ Volume MA length")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“ˆ VVIX è®¾ç½® (Optional)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_vvix = "ğŸ“ˆ VVIX (Optional)"
use_vvix = input.bool(false, "Enable VVIX Integration", group=grp_vvix, tooltip="å¯ç”¨VVIX Enable VVIX\nVVIX=VIXçš„æ³¢åŠ¨ç‡ VIX of VIX")
vvix_threshold_mode = input.string("Z-Score", "VVIX Threshold Mode", options=["Fixed", "Percentile", "Z-Score"], group=grp_vvix, tooltip="Fixed: å›ºå®šé˜ˆå€¼ Fixed (130/80)\nPercentile: ç™¾åˆ†ä½ 90/10 percentile\nZ-Score: æ ‡å‡†å·® Â±2 std dev")
vvix_z_thresh = input.float(2.0, "â””â”€ Z-Score Threshold", minval=1.0, maxval=3.0, step=0.1, group=grp_vvix, tooltip="VVIX Zé˜ˆå€¼ Z threshold\n>é˜ˆå€¼=ææ…Œ Panic / <-é˜ˆå€¼=å¹³é™ Calm")
vvix_panic_thresh = input.float(130.0, "â””â”€ Fixed Panic Threshold", minval=100, maxval=160, group=grp_vvix, tooltip="Fixedæ¨¡å¼ææ…Œé˜ˆå€¼ Fixed panic threshold\nä»…Fixedæ¨¡å¼ For Fixed mode only")
vvix_calm_thresh = input.float(80.0, "â””â”€ Fixed Calm Threshold", minval=60, maxval=100, group=grp_vvix, tooltip="Fixedæ¨¡å¼å¹³é™é˜ˆå€¼ Fixed calm threshold\nä»…Fixedæ¨¡å¼ For Fixed mode only")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å†…éƒ¨è®¡ç®—å‚æ•°ï¼ˆåŸºäºç­–ç•¥æ¨¡å¼ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
smooth_dyn = sens_mode == "High (Scalping)" ? 3 : sens_mode == "Normal (Swing)" ? 5 : 8
thresh_strong = sens_mode == "High (Scalping)" ? 2.0 : sens_mode == "Normal (Swing)" ? 2.2 : 2.5
thresh_mid = sens_mode == "High (Scalping)" ? 1.0 : sens_mode == "Normal (Swing)" ? 1.2 : 1.5
min_score_buy = sens_mode == "High (Scalping)" ? 2 : sens_mode == "Normal (Swing)" ? 3 : 4

t_size = table_size == "Small" ? size.small : table_size == "Large" ? size.large : size.normal
is_mobile = panel_mode == "Mobile"

// ========== 2. æ•°æ®è·å– ==========
// v7.7: Trading Safe Mode é»˜è®¤å¼€å¯ï¼Œä½¿ç”¨ lookahead_off é¿å…é‡ç»˜
// Trading Safe Mode ON (é»˜è®¤): æ— é‡ç»˜ï¼Œå®ç›˜å®‰å…¨
// Trading Safe Mode OFF: ç›˜ä¸­å®æ—¶é¢„è§ˆï¼Œä½†å†å²å¯èƒ½é‡ç»˜
// Legacy Backtest Mode: å‘åå…¼å®¹ï¼Œä¼˜å…ˆçº§ä½äº Trading Safe Mode
vix_tf = vix_timeframe == "Daily" ? "D" : ""
// ç»Ÿä¸€ lookahead ç­–ç•¥ï¼šTrading Safe Mode ä¼˜å…ˆï¼Œç„¶åæ˜¯ Legacy Backtest Mode
is_no_repaint_mode = trading_safe_mode or backtest_mode
lookahead_setting = is_no_repaint_mode ? barmerge.lookahead_off : barmerge.lookahead_on

vix     = request.security(sym_vix_input, vix_tf, close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
vx1     = request.security("CBOE:VX1!", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
vx2     = request.security("CBOE:VX2!", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
vx1_vol = request.security("CBOE:VX1!", "D", volume, lookahead=lookahead_setting, ignore_invalid_symbol=true)
skew    = request.security("CBOE:SKEW", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
pcr     = request.security(sym_pcr_input, "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)

// VVIX æ•°æ® (å¯é€‰)
vvix = use_vvix ? request.security("CBOE:VVIX", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true) : na

// è‡ªåŠ¨æ£€æµ‹é€»è¾‘ï¼šå¦‚æœå›¾è¡¨æ˜¯ QQQ/NQ/NDX ç›¸å…³ï¼Œç”¨ NDXï¼›å¦‚æœæ˜¯ IWM/RUT/RTY ç›¸å…³ï¼Œç”¨ RUTï¼›å¦åˆ™ç”¨ SPX
is_nasdaq_chart = str.contains(str.upper(syminfo.ticker), "QQQ") or 
                  str.contains(str.upper(syminfo.ticker), "NDX") or 
                  str.contains(str.upper(syminfo.ticker), "NQ")
is_russell_chart = str.contains(str.upper(syminfo.ticker), "IWM") or 
                   str.contains(str.upper(syminfo.ticker), "RUT") or 
                   str.contains(str.upper(syminfo.ticker), "RTY")

// ========== 2.1 è‡ªé€‚åº”è¶‹åŠ¿å‡çº¿è®¡ç®— (v7.1 æ–°å¢, v7.7 ç»Ÿä¸€ lookahead) ==========
// æ ¹æ® VIX æ°´å¹³ç¡®å®šè‡ªé€‚åº”å‡çº¿é•¿åº¦
is_high_vol_regime = not na(vix) and vix > vol_thresh
adaptive_ma_len = is_high_vol_regime ? trend_ma_length_high : trend_ma_length_low

// v7.7: è¶‹åŠ¿å‡çº¿ä¹Ÿç»Ÿä¸€ä½¿ç”¨ lookahead_settingï¼Œç¡®ä¿å›æµ‹/å®ç›˜æ¨¡å¼ä¸€è‡´
// è·å–å„æŒ‡æ•°ä»·æ ¼å’Œè¶‹åŠ¿å‡çº¿
spx_close = request.security("SP:SPX", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
ndx_close = request.security("NASDAQ:NDX", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
rut_close = request.security("TVC:RUT", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
manual_close = request.security(manual_trend_src, "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)

// æ ¹æ®æ¨¡å¼è·å–ä¸åŒçš„è¶‹åŠ¿å‡çº¿
// Fixed æ¨¡å¼ï¼šä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ SMA/EMA å’Œå›ºå®šé•¿åº¦
spx_ma_fixed = request.security("SP:SPX", "D", trend_ma_type == "EMA" ? ta.ema(close, trend_ma_length_low) : ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)
ndx_ma_fixed = request.security("NASDAQ:NDX", "D", trend_ma_type == "EMA" ? ta.ema(close, trend_ma_length_low) : ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)
rut_ma_fixed = request.security("TVC:RUT", "D", trend_ma_type == "EMA" ? ta.ema(close, trend_ma_length_low) : ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)
manual_ma_fixed = request.security(manual_trend_src, "D", trend_ma_type == "EMA" ? ta.ema(close, trend_ma_length_low) : ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)

// Adaptive æ¨¡å¼ï¼šæ ¹æ® VIX æ°´å¹³åŠ¨æ€é€‰æ‹©é•¿åº¦ï¼ˆä½¿ç”¨ SMAï¼‰
spx_ma_adapt_high = request.security("SP:SPX", "D", ta.sma(close, trend_ma_length_high), lookahead=lookahead_setting, ignore_invalid_symbol=true)
spx_ma_adapt_low = request.security("SP:SPX", "D", ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)
ndx_ma_adapt_high = request.security("NASDAQ:NDX", "D", ta.sma(close, trend_ma_length_high), lookahead=lookahead_setting, ignore_invalid_symbol=true)
ndx_ma_adapt_low = request.security("NASDAQ:NDX", "D", ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)
rut_ma_adapt_high = request.security("TVC:RUT", "D", ta.sma(close, trend_ma_length_high), lookahead=lookahead_setting, ignore_invalid_symbol=true)
rut_ma_adapt_low = request.security("TVC:RUT", "D", ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)
manual_ma_adapt_high = request.security(manual_trend_src, "D", ta.sma(close, trend_ma_length_high), lookahead=lookahead_setting, ignore_invalid_symbol=true)
manual_ma_adapt_low = request.security(manual_trend_src, "D", ta.sma(close, trend_ma_length_low), lookahead=lookahead_setting, ignore_invalid_symbol=true)

// KAMA æ¨¡å¼ï¼šKaufman è‡ªé€‚åº”å‡çº¿ (ä½¿ç”¨è‡ªå®šä¹‰å®ç°)
spx_ma_kama = request.security("SP:SPX", "D", calc_kama(close, kama_length, 2, 30), lookahead=lookahead_setting, ignore_invalid_symbol=true)
ndx_ma_kama = request.security("NASDAQ:NDX", "D", calc_kama(close, kama_length, 2, 30), lookahead=lookahead_setting, ignore_invalid_symbol=true)
rut_ma_kama = request.security("TVC:RUT", "D", calc_kama(close, kama_length, 2, 30), lookahead=lookahead_setting, ignore_invalid_symbol=true)
manual_ma_kama = request.security(manual_trend_src, "D", calc_kama(close, kama_length, 2, 30), lookahead=lookahead_setting, ignore_invalid_symbol=true)

// æ ¹æ®æ¨¡å¼é€‰æ‹©æœ€ç»ˆä½¿ç”¨çš„å‡çº¿
spx_trend_ma = trend_ma_mode == "KAMA" ? spx_ma_kama : trend_ma_mode == "Adaptive" ? (is_high_vol_regime ? spx_ma_adapt_high : spx_ma_adapt_low) : spx_ma_fixed
ndx_trend_ma = trend_ma_mode == "KAMA" ? ndx_ma_kama : trend_ma_mode == "Adaptive" ? (is_high_vol_regime ? ndx_ma_adapt_high : ndx_ma_adapt_low) : ndx_ma_fixed
rut_trend_ma = trend_ma_mode == "KAMA" ? rut_ma_kama : trend_ma_mode == "Adaptive" ? (is_high_vol_regime ? rut_ma_adapt_high : rut_ma_adapt_low) : rut_ma_fixed
manual_trend_ma = trend_ma_mode == "KAMA" ? manual_ma_kama : trend_ma_mode == "Adaptive" ? (is_high_vol_regime ? manual_ma_adapt_high : manual_ma_adapt_low) : manual_ma_fixed

valid_data = not na(vix) and not na(vx1) and not na(vx2)

// ========== 3. æ ¸å¿ƒè®¡ç®— ==========
// SPX è¶‹åŠ¿åˆ¤æ–­ï¼ˆä½¿ç”¨è‡ªé€‚åº”è¶‹åŠ¿å‡çº¿ï¼‰
is_spx_bull = not na(spx_close) ? (spx_close > spx_trend_ma) : true
// NDX è¶‹åŠ¿åˆ¤æ–­
is_ndx_bull = not na(ndx_close) ? (ndx_close > ndx_trend_ma) : true
// RUT è¶‹åŠ¿åˆ¤æ–­
is_rut_bull = not na(rut_close) ? (rut_close > rut_trend_ma) : true

// ä¸»è¶‹åŠ¿åˆ¤æ–­ï¼ˆç”¨äºè¯„åˆ†ç³»ç»Ÿçš„è¿‡æ»¤ï¼‰
is_primary_bull = auto_detect_index ? 
                  (is_russell_chart ? is_rut_bull : is_nasdaq_chart ? is_ndx_bull : is_spx_bull) : 
                  (not na(manual_close) ? (manual_close > manual_trend_ma) : true)

// è¶‹åŠ¿çŠ¶æ€æ–‡æœ¬ï¼ˆä¸‰æŒ‡æ•°åˆå¹¶æ˜¾ç¤ºï¼‰
spx_emoji = is_spx_bull ? "ğŸŸ¢" : "ğŸ”´"
ndx_emoji = is_ndx_bull ? "ğŸŸ¢" : "ğŸ”´"
rut_emoji = is_rut_bull ? "ğŸŸ¢" : "ğŸ”´"
trend_status_txt = spx_emoji + "SPX " + ndx_emoji + "NDX " + rut_emoji + "RUT"
trend_color = is_spx_bull and is_ndx_bull and is_rut_bull ? color.green : 
              not is_spx_bull and not is_ndx_bull and not is_rut_bull ? color.red : color.orange

// ç”¨äºè¯„åˆ†çš„ is_bull_marketï¼ˆä½¿ç”¨ä¸»è¶‹åŠ¿ï¼‰
is_bull_market = is_primary_bull

// VIX Regime åˆ¤æ–­
vix_regime = vix < vix_low_thresh ? 1 : vix > vix_high_thresh ? 3 : 2
vix_regime_txt = vix_regime == 1 ? "LOW" : vix_regime == 3 ? "HIGH" : "NORM"
vix_regime_color = vix_regime == 1 ? color.lime : vix_regime == 3 ? color.red : color.silver
vix_regime_emoji = vix_regime == 1 ? "ğŸŸ¢" : vix_regime == 3 ? "ğŸ”´" : "âšª"

term_spread = valid_data ? (vx2 - vx1) : 0.0
contango_pct = valid_data and vx1 != 0 ? ((vx2 / vx1) - 1) * 100 : 0.0

// VIX/VX1 Basisï¼ˆç°è´§æº¢ä»·ï¼‰- ææ…Œé¢†å…ˆæŒ‡æ ‡
vix_basis = valid_data and vx1 != 0 ? ((vix / vx1) - 1) * 100 : 0.0

// è‡ªé€‚åº”é˜ˆå€¼è®¡ç®—
vix_basis_pct_high = ta.percentile_linear_interpolation(vix_basis, adapt_lookback, 90)
vix_basis_pct_low = ta.percentile_linear_interpolation(vix_basis, adapt_lookback, 10)
pcr_pct_high = ta.percentile_linear_interpolation(pcr, adapt_lookback, 90)
pcr_pct_low = ta.percentile_linear_interpolation(pcr, adapt_lookback, 10)

// æ ¹æ®è®¾ç½®é€‰æ‹©é˜ˆå€¼æ¨¡å¼
is_basis_panic = use_adaptive_thresholds ? (vix_basis > vix_basis_pct_high) : (vix_basis > 5)
is_basis_calm  = use_adaptive_thresholds ? (vix_basis < vix_basis_pct_low) : (vix_basis < -3)

is_high_vol = valid_data and (vix > vol_thresh)
lookback    = use_adaptive ? (is_high_vol ? len_high : len_low) : len_low
avg   = ta.sma(term_spread, lookback)
stdev = ta.stdev(term_spread, lookback)
raw_z = (valid_data and stdev != 0) ? (term_spread - avg) / stdev : 0.0
z     = ta.ema(raw_z, smooth_dyn)

// Z-Score åŠ¨é‡ï¼ˆå˜åŒ–ç‡ï¼‰- å¸¦ä¸­æ€§åŒºåŸŸ
z_roc = z - z[momentum_bars]
z_momentum_bullish = z_roc < -z_momentum_neutral_zone  // Z åœ¨ä¸‹é™è¶…è¿‡é˜ˆå€¼ï¼ˆææ…ŒåŠ å‰§ï¼‰
z_momentum_bearish = z_roc > z_momentum_neutral_zone   // Z åœ¨ä¸Šå‡è¶…è¿‡é˜ˆå€¼ï¼ˆè´ªå©ªåŠ å‰§ï¼‰
z_momentum_flat = math.abs(z_roc) <= z_momentum_neutral_zone  // ä¸­æ€§åŒºåŸŸ

// å‘¨çº¿ MTF ç¡®è®¤ (v7.7: ç»Ÿä¸€ lookahead ç­–ç•¥)
z_weekly = request.security(syminfo.tickerid, "W", z, lookahead=lookahead_setting, ignore_invalid_symbol=true)
is_weekly_buy_aligned = not na(z_weekly) ? z_weekly < -thresh_mid : true
is_weekly_sell_aligned = not na(z_weekly) ? z_weekly > thresh_mid : true

// Smart SKEW - ä¼˜åŒ–ï¼šæ”¯æŒç™¾åˆ†ä½æ•°æ¨¡å¼
skew_avg   = ta.sma(skew, skew_len)
skew_stdev = ta.stdev(skew, skew_len)
skew_z     = (skew - skew_avg) / skew_stdev

// SKEW ç™¾åˆ†ä½æ•°è®¡ç®—ï¼ˆæ›´è‡ªé€‚åº”ï¼‰
skew_pct_high = ta.percentile_linear_interpolation(skew, 252, 90)
skew_pct_low  = ta.percentile_linear_interpolation(skew, 252, 10)

skew_trig_high = sens_mode == "High (Scalping)" ? 1.5 : 1.8 

// æ ¹æ®æ¨¡å¼é€‰æ‹© SKEW åˆ¤æ–­é€»è¾‘
is_skew_high = skew_mode == "Relative (Z-Score)" ? (skew_z > skew_trig_high) : 
               skew_mode == "Percentile (Adaptive)" ? (skew > skew_pct_high) : 
               (skew > 145)
is_skew_low  = skew_mode == "Relative (Z-Score)" ? (skew_z < -1.5) : 
               skew_mode == "Percentile (Adaptive)" ? (skew < skew_pct_low) : 
               (skew < 110)
scaled_skew = not na(skew) ? (skew - 100) / 10 : na

// VVIX è‡ªé€‚åº”é˜ˆå€¼è®¡ç®— (v7.1 æ–°å¢)
vvix_avg = ta.sma(vvix, 252)
vvix_stdev = ta.stdev(vvix, 252)
vvix_z = not na(vvix) and vvix_stdev != 0 ? (vvix - vvix_avg) / vvix_stdev : 0.0
vvix_pct_high = ta.percentile_linear_interpolation(vvix, 252, 90)
vvix_pct_low  = ta.percentile_linear_interpolation(vvix, 252, 10)

// VVIX åˆ¤æ–­ - æ”¯æŒä¸‰ç§æ¨¡å¼
vvix_panic_check = vvix_threshold_mode == "Z-Score" ? vvix_z > vvix_z_thresh : vvix_threshold_mode == "Percentile" ? vvix > vvix_pct_high : vvix > vvix_panic_thresh
vvix_calm_check = vvix_threshold_mode == "Z-Score" ? vvix_z < -vvix_z_thresh : vvix_threshold_mode == "Percentile" ? vvix < vvix_pct_low : vvix < vvix_calm_thresh
is_vvix_panic = use_vvix and not na(vvix) and vvix_panic_check
is_vvix_calm = use_vvix and not na(vvix) and vvix_calm_check

// Smart Volume - ä½¿ç”¨æ»šåŠ¨çª—å£æœ€å¤§å€¼
vol_ma = ta.sma(vx1_vol, vol_avg_len)
vol_max_rolling = ta.highest(vx1_vol, 252)  // æ»šåŠ¨252æ—¥æœ€å¤§å€¼
is_vol_spike  = vx1_vol >= vol_ma * 2.5 
is_vol_high   = vx1_vol >= vol_ma * 1.5 
col_vol = is_vol_spike ? color.new(color.yellow, 30) : is_vol_high ? color.new(color.aqua, 60) : color.new(color.gray, 90)
vol_visual_boost = is_vol_spike ? 1.2 : 1.0 

// ========== 4. AI ä¿¡å·ç®—æ³• (Enhanced v7.0 - æ¨¡å—åŒ–) ==========
var float score = 0.0

// ä½¿ç”¨æ¨¡å—åŒ–è¯„åˆ†å‡½æ•°
score := calc_z_score_points(z, thresh_mid, thresh_strong) +
         calc_contango_points(contango_pct) +
         calc_basis_points(is_basis_panic, is_basis_calm) +
         calc_skew_points(is_skew_high, is_skew_low) +
         calc_pcr_points(pcr) +
         calc_vvix_points(vvix, use_vvix) +
         (is_vol_spike and z < -thresh_mid ? 1 : 0) +
         (use_momentum_confirm and z < -thresh_mid and z_momentum_bullish ? 1 : 0) +
         (use_momentum_confirm and z > thresh_mid and z_momentum_bearish ? -1 : 0) +
         (use_mtf_confirm and z < -thresh_mid and is_weekly_buy_aligned ? 1 : 0) +
         (use_mtf_confirm and z > thresh_mid and is_weekly_sell_aligned ? -1 : 0) +
         (use_trend_filter and not is_bull_market ? -2 : 0)

// ========== 5. ä¸‰çº§ä¹°å…¥ä¿¡å· (v7.0 æ–°å¢, v7.3 ä¼˜åŒ–) ==========
// åŸºäº Score è¯„çº§çš„ä¿¡å·è§¦å‘ï¼ˆé¦–æ¬¡è¿›å…¥è¯¥è¯„çº§æ—¶è§¦å‘ï¼‰
is_crash_buy_raw = score >= 6 and score[1] < 6
is_strong_buy_raw = score >= 5 and score < 6 and score[1] < 5
is_buy_dip_raw = score >= min_score_buy and score < 5 and score[1] < min_score_buy

// å–å‡ºä¿¡å·åŸå§‹åˆ¤æ–­
is_euphoria_sell_raw = score <= -6 and score[1] > -6
is_strong_sell_raw = score <= -5 and score > -6 and score[1] > -5
is_sell_hedge_raw = score <= -2 and score > -5 and score[1] > -2

// ä¿¡å·ç¡®è®¤æœºåˆ¶ (v7.1 æ–°å¢) - ä»…åœ¨ K çº¿ç¡®è®¤åè§¦å‘
is_crash_buy = use_confirmed_signals ? (is_crash_buy_raw and barstate.isconfirmed) : is_crash_buy_raw
is_strong_buy = use_confirmed_signals ? (is_strong_buy_raw and barstate.isconfirmed) : is_strong_buy_raw
is_buy_dip_base = use_confirmed_signals ? (is_buy_dip_raw and barstate.isconfirmed) : is_buy_dip_raw
is_euphoria_sell = use_confirmed_signals ? (is_euphoria_sell_raw and barstate.isconfirmed) : is_euphoria_sell_raw
is_strong_sell = use_confirmed_signals ? (is_strong_sell_raw and barstate.isconfirmed) : is_strong_sell_raw
is_sell_hedge_base = use_confirmed_signals ? (is_sell_hedge_raw and barstate.isconfirmed) : is_sell_hedge_raw

// ===== v7.3 æ–°å¢ï¼šä¿¡å·å†·å´è¿½è¸ªå˜é‡ =====
var int last_sell_hedge_bar = 0
var int last_buy_dip_bar = 0

// ===== v7.3 æ–°å¢ï¼šå¢å¼ºç‰ˆ sell_hedge/buy_dip ä¿¡å·è¿‡æ»¤ =====
// sell_hedge å¢å¼ºæ¡ä»¶ï¼š
// 1. VIX Regime ä¸æ˜¯ LOW VOLï¼ˆä½æ³¢åŠ¨æœŸä¸éœ€è¦å¯¹å†²ï¼‰
// 2. Z Momentum ä¸Šå‡ï¼ˆè´ªå©ªåŠ å‰§ï¼‰æˆ– Weekly å–å‡ºå¯¹é½
// 3. æ»¡è¶³ä¿¡å·å†·å´é—´éš”
is_sell_hedge_momentum_ok = z_momentum_bearish or (use_mtf_confirm and is_weekly_sell_aligned) or not use_momentum_confirm
is_sell_hedge_cooldown_ok = bar_index - last_sell_hedge_bar > signal_display_cooldown
is_sell_hedge = is_sell_hedge_base and vix_regime != 1 and is_sell_hedge_momentum_ok and is_sell_hedge_cooldown_ok

// buy_dip å¢å¼ºæ¡ä»¶ï¼š
// 1. VIX Regime ä¸æ˜¯ HIGH VOLï¼ˆé«˜æ³¢åŠ¨æœŸç­‰å¾…æ›´å¼ºä¿¡å·ï¼‰
// 2. Z Momentum ä¸‹é™ï¼ˆææ…ŒåŠ å‰§ï¼‰æˆ– Weekly ä¹°å…¥å¯¹é½
// 3. æ»¡è¶³ä¿¡å·å†·å´é—´éš”
is_buy_dip_momentum_ok = z_momentum_bullish or (use_mtf_confirm and is_weekly_buy_aligned) or not use_momentum_confirm
is_buy_dip_cooldown_ok = bar_index - last_buy_dip_bar > signal_display_cooldown
is_buy_dip = is_buy_dip_base and vix_regime != 3 and is_buy_dip_momentum_ok and is_buy_dip_cooldown_ok

// æ›´æ–°å†·å´è¿½è¸ª
if is_sell_hedge
    last_sell_hedge_bar := bar_index
if is_buy_dip
    last_buy_dip_bar := bar_index

// è¶‹åŠ¿è¿‡æ»¤
is_signal_allowed = use_trend_filter ? is_bull_market : true

// æœ€ç»ˆä¿¡å·ï¼ˆç”¨äº Alert å’Œå›¾è¡¨æ ‡ç­¾ï¼‰
final_crash_buy = is_crash_buy  // CRASH BUY ä¸å—è¶‹åŠ¿è¿‡æ»¤é™åˆ¶
final_strong_buy = is_strong_buy  // STRONG BUY ä¸å—è¶‹åŠ¿è¿‡æ»¤é™åˆ¶
final_buy_dip = is_buy_dip and is_signal_allowed  // BUY DIP å—è¶‹åŠ¿è¿‡æ»¤ + v7.3 å¢å¼ºè¿‡æ»¤

final_buy_signal = final_crash_buy or final_strong_buy or final_buy_dip
final_sell_signal = is_euphoria_sell or is_strong_sell or is_sell_hedge

// ========== 6. ä¿¡å·ç»Ÿè®¡ (v7.0 æ–°å¢, v7.7 æ”¹ä¸ºæ»šåŠ¨çª—å£) ==========
// v7.7: ä½¿ç”¨ math.sum() æ»šåŠ¨çª—å£ç»Ÿè®¡ï¼Œæ›¿ä»£ç´¯ç§¯è®¡æ•°
// è¿™ç¡®ä¿ç»Ÿè®¡å§‹ç»ˆåæ˜ "æœ€è¿‘ N å¹´"çš„æ•°æ®ï¼Œä¸ä¼šéšæ—¶é—´æ¼‚ç§»
stats_lookback_bars = stats_lookback_years * 252

// å°†å¸ƒå°”ä¿¡å·è½¬æ¢ä¸ºæ•°å€¼ï¼ˆ0/1ï¼‰ç”¨äº math.sum
crash_buy_num = final_crash_buy ? 1 : 0
strong_buy_num = final_strong_buy ? 1 : 0
buy_dip_num = final_buy_dip ? 1 : 0
sell_signal_num = final_sell_signal ? 1 : 0

// æ»šåŠ¨çª—å£ç»Ÿè®¡ä¿¡å·æ¬¡æ•°
crash_buy_count = math.round(math.sum(crash_buy_num, stats_lookback_bars))
strong_buy_count = math.round(math.sum(strong_buy_num, stats_lookback_bars))
buy_dip_count = math.round(math.sum(buy_dip_num, stats_lookback_bars))
sell_count = math.round(math.sum(sell_signal_num, stats_lookback_bars))

// è®¡ç®—ä¿¡å·ååˆ†çº§å›æŠ¥ï¼ˆä½¿ç”¨ SPX æ”¶ç›Šä½œä¸ºå‚è€ƒï¼‰
// å›æŠ¥è®¡ç®—ï¼šä¿¡å·å‘å‡ºå N å¤©çš„æ”¶ç›Š
crash_spx_return = not na(spx_close) and not na(spx_close[crash_return_bars]) ? (spx_close - spx_close[crash_return_bars]) / spx_close[crash_return_bars] * 100 : 0.0
strong_spx_return = not na(spx_close) and not na(spx_close[strong_return_bars]) ? (spx_close - spx_close[strong_return_bars]) / spx_close[strong_return_bars] * 100 : 0.0
dip_spx_return = not na(spx_close) and not na(spx_close[dip_return_bars]) ? (spx_close - spx_close[dip_return_bars]) / spx_close[dip_return_bars] * 100 : 0.0

// v7.7: æ»šåŠ¨çª—å£æ”¶ç›Šç»Ÿè®¡
// ä»…å½“ N å¤©å‰æœ‰ä¿¡å·æ—¶ï¼Œæ‰è®¡å…¥å½“å‰æ”¶ç›Š
crash_return_contrib = final_crash_buy[crash_return_bars] ? crash_spx_return : 0.0
strong_return_contrib = final_strong_buy[strong_return_bars] ? strong_spx_return : 0.0
dip_return_contrib = final_buy_dip[dip_return_bars] ? dip_spx_return : 0.0

// æ»šåŠ¨çª—å£å†…çš„æ”¶ç›Šæ€»å’Œ
crash_buy_return_sum = math.sum(crash_return_contrib, stats_lookback_bars)
strong_buy_return_sum = math.sum(strong_return_contrib, stats_lookback_bars)
buy_dip_return_sum = math.sum(dip_return_contrib, stats_lookback_bars)

// æ»šåŠ¨çª—å£å†…æœ‰æ•ˆæ”¶ç›Šçš„ä¿¡å·è®¡æ•°ï¼ˆç”¨äºè®¡ç®—å¹³å‡å€¼ï¼‰
crash_return_count_num = final_crash_buy[crash_return_bars] ? 1 : 0
strong_return_count_num = final_strong_buy[strong_return_bars] ? 1 : 0
dip_return_count_num = final_buy_dip[dip_return_bars] ? 1 : 0

crash_buy_return_count = math.round(math.sum(crash_return_count_num, stats_lookback_bars))
strong_buy_return_count = math.round(math.sum(strong_return_count_num, stats_lookback_bars))
buy_dip_return_count = math.round(math.sum(dip_return_count_num, stats_lookback_bars))

// è®¡ç®—å¹³å‡æ”¶ç›Š
crash_buy_avg_return = crash_buy_return_count > 0 ? crash_buy_return_sum / crash_buy_return_count : 0.0
strong_buy_avg_return = strong_buy_return_count > 0 ? strong_buy_return_sum / strong_buy_return_count : 0.0
buy_dip_avg_return = buy_dip_return_count > 0 ? buy_dip_return_sum / buy_dip_return_count : 0.0

// æœ€ç»ˆä¿¡å·ç¿»è¯‘
signal_txt = ""
signal_col = color.gray
signal_emoji = ""

if score >= 6
    signal_txt := "ğŸš¨ CRASH BUY"
    signal_col := color.new(#00FF00, 0)
    signal_emoji := "ğŸš¨"
else if score >= 5
    signal_txt := "ğŸŸ¢ STRONG BUY"
    signal_col := color.green
    signal_emoji := "ğŸŸ¢"
else if score >= min_score_buy
    if vix_regime == 3
        signal_txt := "âœ‹ WAIT (Vol)"
        signal_col := color.gray
        signal_emoji := "âœ‹"
    else if use_momentum_confirm and not is_buy_dip_momentum_ok
        signal_txt := "âœ‹ WAIT (Mom)"
        signal_col := color.gray
        signal_emoji := "âœ‹"
    else
        signal_txt := "ğŸŸ¡ BUY DIP"
        signal_col := color.lime
        signal_emoji := "ğŸŸ¡"
else if score <= -6
    signal_txt := "ğŸ”¥ EUPHORIA"
    signal_col := color.new(#FF0000, 0)
    signal_emoji := "ğŸ”¥"
else if score <= -5
    signal_txt := "ğŸ”´ STRONG SELL"
    signal_col := color.red
    signal_emoji := "ğŸ”´"
else if score <= -2
    if vix_regime == 1
        signal_txt := "â˜• HOLD (Vol)"
        signal_col := color.gray
        signal_emoji := "â˜•"
    else if use_momentum_confirm and not is_sell_hedge_momentum_ok
        signal_txt := "âœ‹ HOLD (Mom)"
        signal_col := color.gray
        signal_emoji := "âœ‹"
    else
        signal_txt := "ğŸŸ  SELL/HEDGE"
        signal_col := color.orange
        signal_emoji := "ğŸŸ "
else
    signal_txt := "â¸ NEUTRAL"
    signal_col := color.gray
    signal_emoji := "â¸"

// ç†Šå¸‚ç‰¹æ®Šæç¤º
if use_trend_filter and not is_bull_market and score >= min_score_buy and score < 5
    signal_txt := "ğŸš« NO TRADE"
    signal_col := color.gray
    signal_emoji := "ğŸš«"

// ========== 7. ç»˜å›¾ ==========
bgcolor(contango_pct > 0 ? color.new(color.green, 95) : color.new(color.red, 92))

col_z = z >= 0 ? color.from_gradient(z, 0, 3, color.new(color.blue, 40), color.new(color.blue, 10)) : 
                 color.from_gradient(z, -3, 0, color.new(color.red, 10), color.new(color.orange, 40))

plot(show_z ? z : na, color=col_z, title="Term Struct Z", linewidth=2)
plot(show_skew ? scaled_skew : na, color=color.new(color.fuchsia, 40), title="SKEW (Scaled)", linewidth=1)

hline(0, "Zero", color=color.gray, linestyle=hline.style_solid)
mid_hline_style = mid_line_style == "Solid" ? hline.style_solid : mid_line_style == "Dashed" ? hline.style_dashed : hline.style_dotted
hline(1, "+1 Mid", color=mid_line_color, linestyle=mid_hline_style)
hline(-1, "-1 Mid", color=mid_line_color, linestyle=mid_hline_style)
plot(thresh_strong, "Upper", color=color.new(color.gray, 50), style=plot.style_line)
plot(-thresh_strong, "Lower", color=color.new(color.gray, 50), style=plot.style_line)

// ä½¿ç”¨æ»šåŠ¨æœ€å¤§å€¼çš„æˆäº¤é‡å¯è§†åŒ–
scaled_vol = not na(vx1_vol) and vol_max_rolling > 0 ? ((vx1_vol * vol_visual_boost) / vol_max_rolling) * 1.8 - 3.8 : na
plot(show_volume ? scaled_vol : na, color=col_vol, title="Smart Volume", style=plot.style_columns, linewidth=2)

// ========== 8. ä¸‰çº§ä¿¡å·å›¾è¡¨æ ‡ç­¾ (v7.0 æ–°å¢) ==========
plotshape(final_crash_buy ? -thresh_strong - 0.3 : na, title="Crash Buy Signal", location=location.absolute, style=shape.labelup, color=color.new(#00FF00, 0), text="ğŸš¨", textcolor=color.white, size=size.small)
plotshape(final_strong_buy ? -thresh_strong - 0.3 : na, title="Strong Buy Signal", location=location.absolute, style=shape.labelup, color=color.new(color.green, 20), text="ğŸŸ¢", textcolor=color.white, size=size.tiny)
plotshape(final_buy_dip ? -thresh_strong - 0.3 : na, title="Buy Dip Signal", location=location.absolute, style=shape.labelup, color=color.new(color.lime, 20), text="ğŸŸ¡", textcolor=color.white, size=size.tiny)

plotshape(is_euphoria_sell ? thresh_strong + 0.3 : na, title="Euphoria Sell Signal", location=location.absolute, style=shape.labeldown, color=color.new(#FF0000, 0), text="ğŸ”¥", textcolor=color.white, size=size.small)
plotshape(is_strong_sell ? thresh_strong + 0.3 : na, title="Strong Sell Signal", location=location.absolute, style=shape.labeldown, color=color.new(color.red, 20), text="ğŸ”´", textcolor=color.white, size=size.tiny)
plotshape(is_sell_hedge ? thresh_strong + 0.3 : na, title="Sell/Hedge Signal", location=location.absolute, style=shape.labeldown, color=color.new(color.orange, 20), text="ğŸŸ ", textcolor=color.white, size=size.tiny)

// ========== 9. é‡æ–°è®¾è®¡çš„ä»ªè¡¨ç›˜ (v7.8) ==========
// ä»ªè¡¨ç›˜ä½ç½®è½¬æ¢å‡½æ•°
get_table_pos(pos) => pos == "Top Left" ? position.top_left : pos == "Bottom Right" ? position.bottom_right : pos == "Bottom Left" ? position.bottom_left : pos == "Top Center" ? position.top_center : pos == "Bottom Center" ? position.bottom_center : position.top_right

// v7.8: æ·±è‰²ä¸»é¢˜é…è‰²
c_header = color.rgb(26, 26, 46)       // #1a1a2e æ ‡é¢˜æ æ·±è“é»‘
c_group  = color.rgb(22, 33, 62)       // #16213e åˆ†ç»„æ ‡é¢˜æ¬¡æ·±è“
c_row    = color.rgb(15, 15, 26, 30)   // #0f0f1a æ™®é€šè¡Œè¿‘é»‘(å¸¦é€æ˜)
c_buy_bg = color.rgb(10, 61, 46, 50)   // #0a3d2e ä¹°å…¥ä¿¡å·æ·±ç»¿èƒŒæ™¯
c_sell_bg = color.rgb(61, 10, 10, 50)  // #3d0a0a å–å‡ºä¿¡å·æ·±çº¢èƒŒæ™¯
c_label  = color.rgb(136, 136, 136)    // #888888 æ ‡ç­¾ç°è‰²
c_value  = color.rgb(255, 255, 255)    // #ffffff æ•°å€¼ç™½è‰²

// æ ¹æ®ä¿¡å·åŠ¨æ€é€‰æ‹©èƒŒæ™¯è‰²
signal_bg = score >= 5 ? c_buy_bg : score <= -5 ? c_sell_bg : c_row

// v7.8: ä»…åœ¨é¢„è§ˆæ¨¡å¼ï¼ˆéå®ç›˜å®‰å…¨æ¨¡å¼ï¼‰æ—¶æ˜¾ç¤ºé‡ç»˜è­¦å‘Š
is_preview_mode = not trading_safe_mode and not backtest_mode

// Mobile: 2è¡Œ, Full: 13è¡Œ
panel_rows = is_mobile ? 2 : 13
var table panel = table.new(get_table_pos(table_position), 2, panel_rows, border_width=0)

if show_table and barstate.islast
    if is_mobile
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Mobile Mode: æç®€2è¡Œ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Row 0: ä¿¡å· + åˆ†æ•°
        table.cell(panel, 0, 0, signal_txt, bgcolor=signal_bg, text_color=signal_col, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 0, str.tostring(score, "+#.#;-#.#"), bgcolor=signal_bg, text_color=signal_col, text_halign=text.align_right, text_size=t_size)
        
        // Row 1: VIXçŠ¶æ€ + æ•°å€¼
        vix_display = vix_regime_emoji + " " + vix_regime_txt
        vix_val_display = str.tostring(vix, "#.#")
        table.cell(panel, 0, 1, vix_display, bgcolor=c_row, text_color=vix_regime_color, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 1, vix_val_display, bgcolor=c_row, text_color=vix_regime_color, text_halign=text.align_right, text_size=t_size)
    else
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Full Mode: åˆ†ç»„å¸ƒå±€ + è¿›åº¦æ¡
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // --- Row 0: æ ‡é¢˜æ  ---
        mode_tag = is_preview_mode ? "âš ï¸PREVIEW" : "ğŸ›¡ï¸SAFE"
        table.cell(panel, 0, 0, "VIX Term Pro", bgcolor=c_header, text_color=c_value, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 0, mode_tag, bgcolor=c_header, text_color=is_preview_mode ? color.orange : color.lime, text_halign=text.align_right, text_size=t_size)
        
        // --- Row 1: ä¿¡å·ï¼ˆåŠ¨æ€é«˜äº®èƒŒæ™¯ï¼‰---
        table.cell(panel, 0, 1, signal_txt, bgcolor=signal_bg, text_color=signal_col, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 1, "", bgcolor=signal_bg, text_color=c_value, text_size=t_size)
        
        // --- Row 2: è¿›åº¦æ¡ + åˆ†æ•° ---
        score_bar = f_score_bar(score)
        score_display = str.tostring(score, "+#.#;-#.#")
        bar_color = score >= 5 ? color.lime : score <= -5 ? color.red : color.silver
        table.cell(panel, 0, 2, score_bar, bgcolor=c_row, text_color=bar_color, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 2, score_display, bgcolor=c_row, text_color=bar_color, text_halign=text.align_right, text_size=t_size)
        
        // --- Row 3: MARKET åˆ†ç»„æ ‡é¢˜ ---
        table.cell(panel, 0, 3, "MARKET", bgcolor=c_group, text_color=c_label, text_halign=text.align_left, text_size=size.tiny)
        table.cell(panel, 1, 3, "", bgcolor=c_group, text_color=c_label, text_size=size.tiny)
        
        // --- Row 4: ä¸‰æŒ‡æ•°è¶‹åŠ¿ ---
        trend_compact = spx_emoji + " " + ndx_emoji + " " + rut_emoji
        table.cell(panel, 0, 4, trend_compact, bgcolor=c_row, text_color=trend_color, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 4, "SPX NDX RUT", bgcolor=c_row, text_color=c_label, text_halign=text.align_right, text_size=size.tiny)
        
        // --- Row 5: VIX Regime ---
        vix_full_display = vix_regime_emoji + " " + vix_regime_txt
        table.cell(panel, 0, 5, vix_full_display, bgcolor=c_row, text_color=vix_regime_color, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 5, str.tostring(vix, "#.#"), bgcolor=c_row, text_color=vix_regime_color, text_halign=text.align_right, text_size=t_size)
        
        // --- Row 6: Volume Status ---
        vol_ratio = not na(vx1_vol) and vol_ma > 0 ? vx1_vol / vol_ma : 0
        vol_txt = is_vol_spike ? "ğŸ”¥ SPIKE" : is_vol_high ? "âš¡ HIGH" : "â—¦ NORM"
        vol_col = is_vol_spike ? color.yellow : is_vol_high ? color.aqua : color.silver
        table.cell(panel, 0, 6, vol_txt, bgcolor=c_row, text_color=vol_col, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 6, str.tostring(vol_ratio, "#.#") + "x", bgcolor=c_row, text_color=vol_col, text_halign=text.align_right, text_size=t_size)
        
        // --- Row 7: STRUCTURE åˆ†ç»„æ ‡é¢˜ ---
        table.cell(panel, 0, 7, "STRUCTURE", bgcolor=c_group, text_color=c_label, text_halign=text.align_left, text_size=size.tiny)
        table.cell(panel, 1, 7, "", bgcolor=c_group, text_color=c_label, text_size=size.tiny)
        
        // --- Row 8: Term Z ---
        z_dir = z_momentum_bullish ? "â–¼" : z_momentum_bearish ? "â–²" : "â†’"
        z_col = z < -thresh_strong ? color.lime : z > thresh_strong ? color.red : color.silver
        table.cell(panel, 0, 8, "Z " + str.tostring(z, "#.##"), bgcolor=c_row, text_color=z_col, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 8, z_dir, bgcolor=c_row, text_color=z_momentum_bullish ? color.lime : z_momentum_bearish ? color.orange : color.silver, text_halign=text.align_right, text_size=t_size)
        
        // --- Row 9: Contango ---
        contango_emoji = contango_pct < 0 ? "âš ï¸" : "âœ“"
        contango_col = contango_pct < 0 ? color.red : color.lime
        table.cell(panel, 0, 9, "Contango", bgcolor=c_row, text_color=c_label, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 9, contango_emoji + str.tostring(contango_pct, "#.#") + "%", bgcolor=c_row, text_color=contango_col, text_halign=text.align_right, text_size=t_size)
        
        // --- Row 10: STATS åˆ†ç»„æ ‡é¢˜ ---
        table.cell(panel, 0, 10, "STATS (" + str.tostring(stats_lookback_years) + "Y)", bgcolor=c_group, text_color=c_label, text_halign=text.align_left, text_size=size.tiny)
        table.cell(panel, 1, 10, "", bgcolor=c_group, text_color=c_label, text_size=size.tiny)
        
        // --- Row 11: CRASH + STRONG ç»Ÿè®¡ ---
        if show_signal_stats
            // æ ¼å¼: ğŸš¨3 +8.2%  ğŸŸ¢5 +4.1%
            crash_ret_str = str.tostring(crash_buy_avg_return, "+#.#;-#.#") + "%"
            strong_ret_str = str.tostring(strong_buy_avg_return, "+#.#;-#.#") + "%"
            stats_left = "ğŸš¨" + str.tostring(crash_buy_count) + " " + crash_ret_str
            stats_right = "ğŸŸ¢" + str.tostring(strong_buy_count) + " " + strong_ret_str
            table.cell(panel, 0, 11, stats_left, bgcolor=c_row, text_color=crash_buy_avg_return >= 0 ? color.lime : color.red, text_halign=text.align_left, text_size=t_size)
            table.cell(panel, 1, 11, stats_right, bgcolor=c_row, text_color=strong_buy_avg_return >= 0 ? color.lime : color.red, text_halign=text.align_right, text_size=t_size)
            
            // --- Row 12: BUY DIP ç»Ÿè®¡ ---
            dip_ret_str = str.tostring(buy_dip_avg_return, "+#.#;-#.#") + "%"
            stats_dip = "ğŸŸ¡" + str.tostring(buy_dip_count) + " " + dip_ret_str
            table.cell(panel, 0, 12, stats_dip, bgcolor=c_row, text_color=buy_dip_avg_return >= 0 ? color.lime : color.red, text_halign=text.align_left, text_size=t_size)
            table.cell(panel, 1, 12, "", bgcolor=c_row, text_color=c_label, text_size=t_size)
        else
            table.cell(panel, 0, 11, "", bgcolor=c_row, text_color=c_label, text_size=t_size)
            table.cell(panel, 1, 11, "", bgcolor=c_row, text_color=c_label, text_size=t_size)
            table.cell(panel, 0, 12, "", bgcolor=c_row, text_color=c_label, text_size=t_size)
            table.cell(panel, 1, 12, "", bgcolor=c_row, text_color=c_label, text_size=t_size)

// ========== 10. SMART ALERT (Unified Alert System v7.5) ==========
// åŸºäº Adaptive RSI Pro çš„æ™ºèƒ½è­¦æŠ¥ä¼˜åŒ–ï¼š
// 1. ä¿¡å·ç­‰çº§ç³»ç»Ÿ (Lv1-3) - å®ç°ä¼˜å…ˆçº§åˆ†çº§
// 2. varip Kçº¿å†…å»é‡ - åŒä¸€Kçº¿å¼±ä¿¡å·ä¸é‡å¤è§¦å‘
// 3. ç­‰çº§å‡çº§è§¦å‘ - å‡ºç°æ›´å¼ºä¿¡å·æ—¶ç«‹å³è§¦å‘æ–°è­¦æŠ¥
// 4. VIX Regime è‡ªé€‚åº”å†·å´ - è·¨Kçº¿çš„é¢å¤–è¿‡æ»¤å±‚

// ä¿¡å·ç­‰çº§å‡½æ•° (ä¼˜å…ˆçº§è¶Šé«˜å€¼è¶Šå¤§)
// Buy: 0=æ— , 1=BUY_DIP, 2=STRONG_BUY, 3=CRASH_BUY
// Sell: 0=æ— , 1=SELL_HEDGE, 2=STRONG_SELL, 3=EUPHORIA_SELL
f_buy_signal_level(_crash, _strong, _dip) =>
    _crash ? 3 : _strong ? 2 : _dip ? 1 : 0
f_sell_signal_level(_euphoria, _strong, _hedge) =>
    _euphoria ? 3 : _strong ? 2 : _hedge ? 1 : 0

// varip: è¿½è¸ªå½“å‰Kçº¿å†…å·²å‘é€çš„æœ€é«˜ä¿¡å·ç­‰çº§ (Kçº¿æ”¶ç›˜æ—¶è‡ªåŠ¨é‡ç½®)
varip int buy_alert_level_sent = 0
varip int sell_alert_level_sent = 0

// var: è·¨Kçº¿å†·å´è¿½è¸ª (ä¿ç•™ VIX Regime è‡ªé€‚åº”å†·å´)
var int last_buy_alert_bar = 0
var int last_sell_alert_bar = 0

// v7.7: è¿½è¸ªä¸Šä¸€æ ¹Kçº¿çš„ä¿¡å·ç­‰çº§ï¼Œç”¨äºæ£€æµ‹è·¨Kçº¿å‡çº§
var int prev_bar_buy_level = 0
var int prev_bar_sell_level = 0

// æ–°Kçº¿å¼€å§‹æ—¶é‡ç½®ç­‰çº§è¿½è¸ªï¼Œå¹¶ä¿å­˜ä¸Šä¸€Kçº¿ç­‰çº§
if barstate.isnew
    prev_bar_buy_level := buy_alert_level_sent
    prev_bar_sell_level := sell_alert_level_sent
    buy_alert_level_sent := 0
    sell_alert_level_sent := 0

// VIX Regime è‡ªé€‚åº”å†·å´ï¼šé«˜æ³¢åŠ¨å‡åŠï¼Œä½æ³¢åŠ¨åŠ å€
adaptive_cooldown = vix_regime == 3 ? math.round(alert_cooldown_base / 2) : vix_regime == 1 ? alert_cooldown_base * 2 : alert_cooldown_base

if enable_smart_alert
    // ===== ä¹°å…¥ä¿¡å·èšåˆ =====
    has_buy_signal = final_crash_buy or final_strong_buy or final_buy_dip
    has_buy_signal_prev = (final_crash_buy[1] == true) or (final_strong_buy[1] == true) or (final_buy_dip[1] == true)
    current_buy_level = f_buy_signal_level(final_crash_buy, final_strong_buy, final_buy_dip)
    
    // v7.7: ä¿®å¤è·¨Kçº¿ç­‰çº§å‡çº§è§¦å‘
    // è§¦å‘æ¡ä»¶ï¼š
    // 1. ä¸Šå‡æ²¿ï¼ˆæ— ä¿¡å·â†’æœ‰ä¿¡å·ï¼‰+ Kçº¿å†…ç­‰çº§å‡çº§
    // 2. æˆ–è€…è·¨Kçº¿ç­‰çº§å‡çº§ï¼ˆDIPâ†’STRONGâ†’CRASHï¼‰
    is_rising_edge_buy = has_buy_signal and not has_buy_signal_prev and current_buy_level > buy_alert_level_sent
    is_cross_bar_upgrade_buy = has_buy_signal and current_buy_level > prev_bar_buy_level and current_buy_level > buy_alert_level_sent
    is_new_buy = is_rising_edge_buy or is_cross_bar_upgrade_buy
    
    if is_new_buy and (bar_index - last_buy_alert_bar > adaptive_cooldown)
        // æ„å»ºæ¶ˆæ¯å¤´ (å«ç­‰çº§æ ‡ç­¾ + å‡çº§æ ‡è®°)
        upgrade_marker = is_cross_bar_upgrade_buy and has_buy_signal_prev ? "â¬†ï¸" : ""
        level_txt = current_buy_level == 3 ? "[Lv3ğŸ”¥]" : current_buy_level == 2 ? "[Lv2]" : "[Lv1]"
        msg = str.format("{0}: ğŸŸ¢ BUY {1}{2} â†’ ", syminfo.ticker, level_txt, upgrade_marker)
        
        // æ·»åŠ è§¦å‘çš„ä¿¡å·æ ‡ç­¾
        if final_crash_buy
            msg := msg + "ğŸš¨CRASH "
        if final_strong_buy
            msg := msg + "ğŸŸ¢STRONG "
        if final_buy_dip
            msg := msg + "ğŸŸ¡DIP "
        
        // æ·»åŠ ä¸Šä¸‹æ–‡ï¼šScore, Z, VIX Regime, æŒ‡æ•°è¶‹åŠ¿
        msg := msg + str.format("| Score:{0} Z:{1,number,#.##} VIX:{2,number,#.#}({3}) {4}", 
            score, z, vix, vix_regime_txt, trend_status_txt)
        
        alert(msg, alert_freq)
        buy_alert_level_sent := current_buy_level
        last_buy_alert_bar := bar_index
    
    // ===== å–å‡ºä¿¡å·èšåˆ =====
    has_sell_signal = is_euphoria_sell or is_strong_sell or is_sell_hedge
    has_sell_signal_prev = (is_euphoria_sell[1] == true) or (is_strong_sell[1] == true) or (is_sell_hedge[1] == true)
    current_sell_level = f_sell_signal_level(is_euphoria_sell, is_strong_sell, is_sell_hedge)
    
    // v7.7: ä¿®å¤è·¨Kçº¿ç­‰çº§å‡çº§è§¦å‘
    // è§¦å‘æ¡ä»¶ï¼š
    // 1. ä¸Šå‡æ²¿ï¼ˆæ— ä¿¡å·â†’æœ‰ä¿¡å·ï¼‰+ Kçº¿å†…ç­‰çº§å‡çº§
    // 2. æˆ–è€…è·¨Kçº¿ç­‰çº§å‡çº§ï¼ˆHEDGEâ†’STRONGâ†’EUPHORIAï¼‰
    is_rising_edge_sell = has_sell_signal and not has_sell_signal_prev and current_sell_level > sell_alert_level_sent
    is_cross_bar_upgrade_sell = has_sell_signal and current_sell_level > prev_bar_sell_level and current_sell_level > sell_alert_level_sent
    is_new_sell = is_rising_edge_sell or is_cross_bar_upgrade_sell
    
    if is_new_sell and (bar_index - last_sell_alert_bar > adaptive_cooldown)
        // æ„å»ºæ¶ˆæ¯å¤´ (å«ç­‰çº§æ ‡ç­¾ + å‡çº§æ ‡è®°)
        upgrade_marker = is_cross_bar_upgrade_sell and has_sell_signal_prev ? "â¬†ï¸" : ""
        level_txt = current_sell_level == 3 ? "[Lv3ğŸ”¥]" : current_sell_level == 2 ? "[Lv2]" : "[Lv1]"
        msg = str.format("{0}: ğŸ”´ SELL {1}{2} â†’ ", syminfo.ticker, level_txt, upgrade_marker)
        
        if is_euphoria_sell
            msg := msg + "ğŸ”¥EUPHORIA "
        if is_strong_sell
            msg := msg + "ğŸ”´STRONG "
        if is_sell_hedge
            msg := msg + "ğŸŸ HEDGE "
        
        // æ·»åŠ ä¸Šä¸‹æ–‡ï¼šScore, Z, SKEW, æŒ‡æ•°è¶‹åŠ¿
        msg := msg + str.format("| Score:{0} Z:{1,number,#.##} SKEW:{2,number,#} {3}", 
            score, z, skew, trend_status_txt)
        
        alert(msg, alert_freq)
        sell_alert_level_sent := current_sell_level
        last_sell_alert_bar := bar_index
