//@version=5
indicator("VIX Term Structure Pro [v7.0 Enhanced]", overlay=false, max_lines_count=500)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    VIX Term Structure Pro v7.0 ä½¿ç”¨æŒ‡å—                      â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Š ä»ªè¡¨ç›˜æŒ‡æ ‡è§£è¯»                                                           â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ æŒ‡æ ‡           â”‚ çœ‹æ¶¨ä¿¡å· ğŸŸ¢              â”‚ çœ‹è·Œä¿¡å· ğŸ”´                     â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ Overall Bias   â”‚ STRONG BUY / BUY DIP    â”‚ STRONG SELL / SELL/HEDGE       â•‘
// â•‘ AI Score       â”‚ â‰¥ 5 (æåº¦ææ…Œ)           â”‚ â‰¤ -5 (æåº¦è´ªå©ª)                 â•‘
// â•‘ Market Trend   â”‚ ğŸŸ¢SPX ğŸŸ¢NDX             â”‚ ğŸ”´SPX ğŸ”´NDX                     â•‘
// â•‘ VIX Regime     â”‚ LOW VOL (<15)           â”‚ HIGH VOL (>25)                 â•‘
// â•‘ Term Struct Z  â”‚ < -2.0 (ææ…Œ)           â”‚ > 2.0 (è´ªå©ª)                    â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Œ v7.0 æ–°å¢ï¼šä¸‰çº§ä¹°å…¥ä¿¡å·                                                   â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ ğŸš¨ CRASH BUY      â”‚ Score â‰¥ 6  â”‚ æç«¯ææ…Œï¼ŒæŠ„åº•æœºä¼š                        â•‘
// â•‘ ğŸŸ¢ STRONG BUY     â”‚ Score â‰¥ 5  â”‚ å¤šå› å­å…±æŒ¯ï¼Œå¯å»ºä»“                        â•‘
// â•‘ ğŸŸ¡ BUY DIP        â”‚ Score â‰¥ 4  â”‚ é€¢ä½å¸çº³                                  â•‘
// â•‘ Signal Stats: å›¾è¡¨å†å²ä¿¡å·ç»Ÿè®¡ (ğŸš¨:N ğŸŸ¢:N ğŸŸ¡:N)                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ========== è¯„åˆ†å‡½æ•°å®šä¹‰ (æ¨¡å—åŒ–) ==========
calc_z_score_points(z_val, mid, strong) =>
    z_val < -strong ? 4 : z_val < -mid ? 2 : z_val > strong ? -4 : z_val > mid ? -2 : 0

calc_contango_points(contango) =>
    contango < 0 ? 2 : contango > 10 ? -1 : 0

calc_basis_points(is_panic, is_calm) =>
    is_panic ? 2 : is_calm ? -1 : 0

calc_skew_points(is_high, is_low) =>
    is_high ? -3 : is_low ? 1 : 0

calc_pcr_points(pcr_val) =>
    na(pcr_val) ? 0 : pcr_val > 1.20 ? 2 : pcr_val < 0.70 ? -2 : 0

calc_vvix_points(vvix_val, use_vvix) =>
    not use_vvix or na(vvix_val) ? 0 : vvix_val > 130 ? 1 : vvix_val < 80 ? -1 : 0

// ========== 1. å‚æ•°è®¾ç½® ==========

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“¡ æ•°æ®æºè®¾ç½® (Data Sources)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_data = "ğŸ“¡ Data Sources"
backtest_mode = input.bool(false, "ğŸ”¬ Backtest Mode", group=grp_data, tooltip="OFF: å®æ—¶æ¨¡å¼ï¼Œæ˜¾ç¤ºå½“æ—¥æ•°æ®ï¼ˆé€‚åˆå®ç›˜ç›‘æ§ï¼‰\nON: å›æµ‹æ¨¡å¼ï¼Œä»…ä½¿ç”¨å·²ç¡®è®¤çš„å†å²æ•°æ®ï¼ˆé¿å…æœªæ¥å‡½æ•°ï¼‰")
sym_vix_input = input.symbol("CBOE:VIX", "VIX Symbol", group=grp_data, tooltip="Default: CBOE:VIX. Alternative: TVC:VIX")
vix_timeframe = input.string("Daily", "VIX Timeframe", options=["Daily", "Chart"], group=grp_data, tooltip="Daily: ä½¿ç”¨æ—¥çº¿æ”¶ç›˜ä»·ï¼ˆç¨³å®šï¼‰\nChart: è·Ÿéšå½“å‰å›¾è¡¨æ—¶é—´æ¡†æ¶ï¼ˆæ›´å®æ—¶ï¼‰")
sym_pcr_input = input.symbol("INDEX:CPCI", "Put/Call Ratio Symbol", group=grp_data, tooltip="Default: INDEX:CPCI (Index P/C). Alternative: INDEX:PCC (Equity P/C)")
manual_trend_src = input.symbol("SP:SPX", "Manual Trend Source", group=grp_data, tooltip="Only used when Auto-Detect Index is OFF")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš ï¸ ç­–ç•¥æ¨¡å¼ (Strategy Mode) - æ ¸å¿ƒè®¾ç½®
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_strategy = "âš ï¸ Strategy Mode (æ ¸å¿ƒè®¾ç½®)"
sens_mode = input.string("Low (Trend/Safe)", "Signal Sensitivity", options=["High (Scalping)", "Normal (Swing)", "Low (Trend/Safe)"], group=grp_strategy, tooltip="High: æ›´æ•æ„Ÿï¼Œé€‚åˆçŸ­çº¿\nNormal: å¹³è¡¡æ¨¡å¼\nLow: æ›´ä¿å®ˆï¼Œé€‚åˆè¶‹åŠ¿è·Ÿè¸ª")
use_trend_filter = input.bool(true, "ğŸ›¡ï¸ Market Trend Filter (MA200)", group=grp_strategy, tooltip="If ON: 'BUY DIP' is DISABLED when primary index is below MA200.\nOnly 'STRONG BUY' (Crash) signals are allowed in Bear Markets.")
auto_detect_index = input.bool(true, "Auto-Detect Index (Based on Chart)", group=grp_strategy, tooltip="Auto: If chart is QQQ/NQ/NDX related, use NDX as primary. Otherwise use SPX.\nManual: Use the symbol specified in Data Sources.")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ¯ ä¿¡å·ç¡®è®¤ (Signal Confirmation)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_confirm = "ğŸ¯ Signal Confirmation"
use_momentum_confirm = input.bool(true, "Use Momentum Confirmation", group=grp_confirm, tooltip="Require Z-Score momentum to confirm signals")
momentum_bars = input.int(3, "Momentum Lookback Bars", minval=1, maxval=10, group=grp_confirm)
z_momentum_neutral_zone = input.float(0.05, "Z Momentum Neutral Zone", minval=0.01, maxval=0.2, step=0.01, group=grp_confirm, tooltip="Z-Score change threshold to filter noise")
use_mtf_confirm = input.bool(false, "Use Weekly MTF Confirmation", group=grp_confirm, tooltip="Require weekly Z-Score alignment for strongest signals")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ¨ å›¾è¡¨æ ·å¼ (Chart Style)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_chart = "ğŸ¨ Chart Style"
show_z      = input.bool(true, "Show Term Struct Z-Score", group=grp_chart)
show_skew   = input.bool(false, "Show Scaled SKEW Line", group=grp_chart)
show_volume = input.bool(true, "Show Smart Volume", group=grp_chart)
mid_line_color = input.color(color.yellow, "Â±1 Line Color", group=grp_chart)
mid_line_style = input.string("Dashed", "Â±1 Line Style", options=["Solid", "Dashed", "Dotted"], group=grp_chart)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ ä»ªè¡¨ç›˜è®¾ç½® (Dashboard)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_dashboard = "ï¿½ Dashboard"
show_table  = input.bool(true, "Show Dashboard", group=grp_dashboard)
panel_mode  = input.string("Compact", "Dashboard Mode", options=["Compact", "Full"], group=grp_dashboard, tooltip="Compact: 8 rows, essential info only\nFull: 12+ rows, all indicators visible")
table_size  = input.string("Normal", "Dashboard Text Size", options=["Small", "Normal", "Large"], group=grp_dashboard)
bg_transp   = input.int(70, "Dashboard Transparency", minval=0, maxval=100, group=grp_dashboard)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Š ç»Ÿè®¡ä¸è­¦æŠ¥ (Statistics & Alerts)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_stats = "ğŸ“Š Statistics & Alerts"
show_signal_stats = input.bool(true, "Show Signal Statistics", group=grp_stats)
stats_lookback_years = input.int(3, "Stats Lookback (Years)", minval=1, maxval=20, group=grp_stats, tooltip="Only count signals within the last N years")
crash_return_bars = input.int(40, "ğŸš¨ CRASH Return Period (Bars)", minval=10, maxval=60, group=grp_stats, tooltip="~2 months for extreme panic recovery")
strong_return_bars = input.int(20, "ğŸŸ¢ STRONG Return Period (Bars)", minval=10, maxval=40, group=grp_stats, tooltip="~1 month for strong signals")
dip_return_bars = input.int(10, "ğŸŸ¡ DIP Return Period (Bars)", minval=5, maxval=20, group=grp_stats, tooltip="~2 weeks for dip buying")
alert_cooldown = input.int(5, "Alert Cooldown (Bars)", minval=1, maxval=20, group=grp_stats, tooltip="Minimum bars between alerts to prevent spam")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš™ï¸ é«˜çº§è®¾ç½® (Advanced Settings)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_advanced = "âš™ï¸ Advanced Settings"

// VIX Regime é˜ˆå€¼
vix_low_thresh = input.float(15.0, "VIX Low Vol Threshold", minval=10, maxval=20, group=grp_advanced, tooltip="Below this = LOW VOL regime")
vix_high_thresh = input.float(25.0, "VIX High Vol Threshold", minval=20, maxval=40, group=grp_advanced, tooltip="Above this = HIGH VOL regime")

// è‡ªé€‚åº”é˜ˆå€¼
use_adaptive_thresholds = input.bool(true, "Use Adaptive Thresholds", group=grp_advanced, tooltip="Use percentile-based dynamic thresholds instead of fixed values")
adapt_lookback = input.int(252, "Adaptive Lookback Period", minval=50, maxval=500, group=grp_advanced)

// Z-Score è®¡ç®—
use_adaptive = input.bool(true, "Use Adaptive Lookback (Z-Score)", group=grp_advanced, tooltip="Shorter lookback in high-vol periods")
len_low      = input.int(252, "Lookback (Low Vol)", minval=50, group=grp_advanced)
len_high     = input.int(126, "Lookback (High Vol)", minval=20, group=grp_advanced)
vol_thresh   = input.float(20.0, "Vol Regime Threshold", minval=10, group=grp_advanced)

// SKEW è®¾ç½®
skew_mode    = input.string("Relative (Z-Score)", "SKEW Logic Mode", options=["Relative (Z-Score)", "Percentile (Adaptive)", "Absolute (>140)"], group=grp_advanced)
skew_len     = input.int(126, "SKEW Lookback Period", minval=20, group=grp_advanced)

// æˆäº¤é‡è®¾ç½®
vol_avg_len  = input.int(20, "Volume Avg Length", minval=5, group=grp_advanced)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“ˆ VVIX è®¾ç½® (Optional)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grp_vvix = "ğŸ“ˆ VVIX (Optional)"
use_vvix = input.bool(false, "Enable VVIX Integration", group=grp_vvix, tooltip="VVIX = VIX of VIX, measures expected volatility of VIX itself")
vvix_panic_thresh = input.float(130.0, "VVIX Panic Threshold", minval=100, maxval=160, group=grp_vvix)
vvix_calm_thresh = input.float(80.0, "VVIX Calm Threshold", minval=60, maxval=100, group=grp_vvix)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å†…éƒ¨è®¡ç®—å‚æ•°ï¼ˆåŸºäºç­–ç•¥æ¨¡å¼ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
smooth_dyn = sens_mode == "High (Scalping)" ? 3 : sens_mode == "Normal (Swing)" ? 5 : 8
thresh_strong = sens_mode == "High (Scalping)" ? 2.0 : sens_mode == "Normal (Swing)" ? 2.2 : 2.5
thresh_mid = sens_mode == "High (Scalping)" ? 1.0 : sens_mode == "Normal (Swing)" ? 1.2 : 1.5
min_score_buy = sens_mode == "High (Scalping)" ? 2 : sens_mode == "Normal (Swing)" ? 3 : 4

t_size = table_size == "Small" ? size.small : table_size == "Large" ? size.large : size.normal
is_compact = panel_mode == "Compact"

// ========== 2. æ•°æ®è·å– ==========
// Backtest Mode OFF: ä½¿ç”¨ lookahead_on è·å–å½“æ—¥å®æ—¶æ•°æ®
// Backtest Mode ON: ç¦ç”¨ lookaheadï¼Œä»…ä½¿ç”¨å·²ç¡®è®¤çš„å†å²æ•°æ®
vix_tf = vix_timeframe == "Daily" ? "D" : ""
lookahead_setting = backtest_mode ? barmerge.lookahead_off : barmerge.lookahead_on

vix     = request.security(sym_vix_input, vix_tf, close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
vx1     = request.security("CBOE:VX1!", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
vx2     = request.security("CBOE:VX2!", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
vx1_vol = request.security("CBOE:VX1!", "D", volume, lookahead=lookahead_setting, ignore_invalid_symbol=true)
skew    = request.security("CBOE:SKEW", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)
pcr     = request.security(sym_pcr_input, "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true)

// VVIX æ•°æ® (å¯é€‰)
vvix = use_vvix ? request.security("CBOE:VVIX", "D", close, lookahead=lookahead_setting, ignore_invalid_symbol=true) : na

// è‡ªåŠ¨æ£€æµ‹é€»è¾‘ï¼šå¦‚æœå›¾è¡¨æ˜¯ QQQ/NQ/NDX ç›¸å…³ï¼Œç”¨ NDXï¼›å¦‚æœæ˜¯ IWM/RUT/RTY ç›¸å…³ï¼Œç”¨ RUTï¼›å¦åˆ™ç”¨ SPX
is_nasdaq_chart = str.contains(str.upper(syminfo.ticker), "QQQ") or 
                  str.contains(str.upper(syminfo.ticker), "NDX") or 
                  str.contains(str.upper(syminfo.ticker), "NQ")
is_russell_chart = str.contains(str.upper(syminfo.ticker), "IWM") or 
                   str.contains(str.upper(syminfo.ticker), "RUT") or 
                   str.contains(str.upper(syminfo.ticker), "RTY")

// è·å–åŒæŒ‡æ•°è¶‹åŠ¿æ•°æ® (SPX + NDX)
spx_close = request.security("SP:SPX", "D", close, ignore_invalid_symbol=true)
spx_ma200 = request.security("SP:SPX", "D", ta.sma(close, 200), ignore_invalid_symbol=true)
ndx_close = request.security("NASDAQ:NDX", "D", close, ignore_invalid_symbol=true)
ndx_ma200 = request.security("NASDAQ:NDX", "D", ta.sma(close, 200), ignore_invalid_symbol=true)
rut_close = request.security("TVC:RUT", "D", close, ignore_invalid_symbol=true)
rut_ma200 = request.security("TVC:RUT", "D", ta.sma(close, 200), ignore_invalid_symbol=true)

// å¦‚æœç”¨æˆ·å…³é—­è‡ªåŠ¨æ£€æµ‹ï¼Œä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ symbol
manual_close = request.security(manual_trend_src, "D", close, ignore_invalid_symbol=true)
manual_ma200 = request.security(manual_trend_src, "D", ta.sma(close, 200), ignore_invalid_symbol=true)

valid_data = not na(vix) and not na(vx1) and not na(vx2)

// ========== 3. æ ¸å¿ƒè®¡ç®— ==========
// SPX è¶‹åŠ¿åˆ¤æ–­
is_spx_bull = not na(spx_close) ? (spx_close > spx_ma200) : true
// NDX è¶‹åŠ¿åˆ¤æ–­
is_ndx_bull = not na(ndx_close) ? (ndx_close > ndx_ma200) : true
// RUT è¶‹åŠ¿åˆ¤æ–­
is_rut_bull = not na(rut_close) ? (rut_close > rut_ma200) : true

// ä¸»è¶‹åŠ¿åˆ¤æ–­ï¼ˆç”¨äºè¯„åˆ†ç³»ç»Ÿçš„è¿‡æ»¤ï¼‰
is_primary_bull = auto_detect_index ? 
                  (is_russell_chart ? is_rut_bull : is_nasdaq_chart ? is_ndx_bull : is_spx_bull) : 
                  (not na(manual_close) ? (manual_close > manual_ma200) : true)

// è¶‹åŠ¿çŠ¶æ€æ–‡æœ¬ï¼ˆä¸‰æŒ‡æ•°åˆå¹¶æ˜¾ç¤ºï¼‰
spx_emoji = is_spx_bull ? "ğŸŸ¢" : "ğŸ”´"
ndx_emoji = is_ndx_bull ? "ğŸŸ¢" : "ğŸ”´"
rut_emoji = is_rut_bull ? "ğŸŸ¢" : "ğŸ”´"
trend_status_txt = spx_emoji + "SPX " + ndx_emoji + "NDX " + rut_emoji + "RUT"
trend_color = is_spx_bull and is_ndx_bull and is_rut_bull ? color.green : 
              not is_spx_bull and not is_ndx_bull and not is_rut_bull ? color.red : color.orange

// ç”¨äºè¯„åˆ†çš„ is_bull_marketï¼ˆä½¿ç”¨ä¸»è¶‹åŠ¿ï¼‰
is_bull_market = is_primary_bull

// VIX Regime åˆ¤æ–­
vix_regime = vix < vix_low_thresh ? 1 : vix > vix_high_thresh ? 3 : 2
vix_regime_txt = vix_regime == 1 ? "LOW VOL" : vix_regime == 3 ? "HIGH VOL" : "NORMAL"
vix_regime_color = vix_regime == 1 ? color.lime : vix_regime == 3 ? color.red : color.silver

term_spread = valid_data ? (vx2 - vx1) : 0.0
contango_pct = valid_data and vx1 != 0 ? ((vx2 / vx1) - 1) * 100 : 0.0

// VIX/VX1 Basisï¼ˆç°è´§æº¢ä»·ï¼‰- ææ…Œé¢†å…ˆæŒ‡æ ‡
vix_basis = valid_data and vx1 != 0 ? ((vix / vx1) - 1) * 100 : 0.0

// è‡ªé€‚åº”é˜ˆå€¼è®¡ç®—
vix_basis_pct_high = ta.percentile_linear_interpolation(vix_basis, adapt_lookback, 90)
vix_basis_pct_low = ta.percentile_linear_interpolation(vix_basis, adapt_lookback, 10)
pcr_pct_high = ta.percentile_linear_interpolation(pcr, adapt_lookback, 90)
pcr_pct_low = ta.percentile_linear_interpolation(pcr, adapt_lookback, 10)

// æ ¹æ®è®¾ç½®é€‰æ‹©é˜ˆå€¼æ¨¡å¼
is_basis_panic = use_adaptive_thresholds ? (vix_basis > vix_basis_pct_high) : (vix_basis > 5)
is_basis_calm  = use_adaptive_thresholds ? (vix_basis < vix_basis_pct_low) : (vix_basis < -3)

is_high_vol = valid_data and (vix > vol_thresh)
lookback    = use_adaptive ? (is_high_vol ? len_high : len_low) : len_low
avg   = ta.sma(term_spread, lookback)
stdev = ta.stdev(term_spread, lookback)
raw_z = (valid_data and stdev != 0) ? (term_spread - avg) / stdev : 0.0
z     = ta.ema(raw_z, smooth_dyn)

// Z-Score åŠ¨é‡ï¼ˆå˜åŒ–ç‡ï¼‰- å¸¦ä¸­æ€§åŒºåŸŸ
z_roc = z - z[momentum_bars]
z_momentum_bullish = z_roc < -z_momentum_neutral_zone  // Z åœ¨ä¸‹é™è¶…è¿‡é˜ˆå€¼ï¼ˆææ…ŒåŠ å‰§ï¼‰
z_momentum_bearish = z_roc > z_momentum_neutral_zone   // Z åœ¨ä¸Šå‡è¶…è¿‡é˜ˆå€¼ï¼ˆè´ªå©ªåŠ å‰§ï¼‰
z_momentum_flat = math.abs(z_roc) <= z_momentum_neutral_zone  // ä¸­æ€§åŒºåŸŸ

// å‘¨çº¿ MTF ç¡®è®¤
z_weekly = request.security(syminfo.tickerid, "W", z, ignore_invalid_symbol=true)
is_weekly_buy_aligned = not na(z_weekly) ? z_weekly < -thresh_mid : true
is_weekly_sell_aligned = not na(z_weekly) ? z_weekly > thresh_mid : true

// Smart SKEW - ä¼˜åŒ–ï¼šæ”¯æŒç™¾åˆ†ä½æ•°æ¨¡å¼
skew_avg   = ta.sma(skew, skew_len)
skew_stdev = ta.stdev(skew, skew_len)
skew_z     = (skew - skew_avg) / skew_stdev

// SKEW ç™¾åˆ†ä½æ•°è®¡ç®—ï¼ˆæ›´è‡ªé€‚åº”ï¼‰
skew_pct_high = ta.percentile_linear_interpolation(skew, 252, 90)
skew_pct_low  = ta.percentile_linear_interpolation(skew, 252, 10)

skew_trig_high = sens_mode == "High (Scalping)" ? 1.5 : 1.8 

// æ ¹æ®æ¨¡å¼é€‰æ‹© SKEW åˆ¤æ–­é€»è¾‘
is_skew_high = skew_mode == "Relative (Z-Score)" ? (skew_z > skew_trig_high) : 
               skew_mode == "Percentile (Adaptive)" ? (skew > skew_pct_high) : 
               (skew > 145)
is_skew_low  = skew_mode == "Relative (Z-Score)" ? (skew_z < -1.5) : 
               skew_mode == "Percentile (Adaptive)" ? (skew < skew_pct_low) : 
               (skew < 110)
scaled_skew = not na(skew) ? (skew - 100) / 10 : na

// VVIX åˆ¤æ–­
is_vvix_panic = use_vvix and not na(vvix) and vvix > vvix_panic_thresh
is_vvix_calm = use_vvix and not na(vvix) and vvix < vvix_calm_thresh

// Smart Volume - ä½¿ç”¨æ»šåŠ¨çª—å£æœ€å¤§å€¼
vol_ma = ta.sma(vx1_vol, vol_avg_len)
vol_max_rolling = ta.highest(vx1_vol, 252)  // æ»šåŠ¨252æ—¥æœ€å¤§å€¼
is_vol_spike  = vx1_vol >= vol_ma * 2.5 
is_vol_high   = vx1_vol >= vol_ma * 1.5 
col_vol = is_vol_spike ? color.new(color.yellow, 30) : is_vol_high ? color.new(color.aqua, 60) : color.new(color.gray, 90)
vol_visual_boost = is_vol_spike ? 1.2 : 1.0 

// ========== 4. AI ä¿¡å·ç®—æ³• (Enhanced v7.0 - æ¨¡å—åŒ–) ==========
var float score = 0.0

// ä½¿ç”¨æ¨¡å—åŒ–è¯„åˆ†å‡½æ•°
score := calc_z_score_points(z, thresh_mid, thresh_strong) +
         calc_contango_points(contango_pct) +
         calc_basis_points(is_basis_panic, is_basis_calm) +
         calc_skew_points(is_skew_high, is_skew_low) +
         calc_pcr_points(pcr) +
         calc_vvix_points(vvix, use_vvix) +
         (is_vol_spike and z < -thresh_mid ? 1 : 0) +
         (use_momentum_confirm and z < -thresh_mid and z_momentum_bullish ? 1 : 0) +
         (use_momentum_confirm and z > thresh_mid and z_momentum_bearish ? -1 : 0) +
         (use_mtf_confirm and z < -thresh_mid and is_weekly_buy_aligned ? 1 : 0) +
         (use_mtf_confirm and z > thresh_mid and is_weekly_sell_aligned ? -1 : 0) +
         (use_trend_filter and not is_bull_market ? -2 : 0)

// ========== 5. ä¸‰çº§ä¹°å…¥ä¿¡å· (v7.0 æ–°å¢) ==========
// åŸºäº Score è¯„çº§çš„ä¿¡å·è§¦å‘ï¼ˆé¦–æ¬¡è¿›å…¥è¯¥è¯„çº§æ—¶è§¦å‘ï¼‰
is_crash_buy = score >= 6 and score[1] < 6
is_strong_buy = score >= 5 and score < 6 and score[1] < 5
is_buy_dip = score >= min_score_buy and score < 5 and score[1] < min_score_buy

// å–å‡ºä¿¡å·
is_euphoria_sell = score <= -6 and score[1] > -6
is_strong_sell = score <= -5 and score > -6 and score[1] > -5
is_sell_hedge = score <= -2 and score > -5 and score[1] > -2

// è¶‹åŠ¿è¿‡æ»¤
is_signal_allowed = use_trend_filter ? is_bull_market : true

// æœ€ç»ˆä¿¡å·ï¼ˆç”¨äº Alert å’Œå›¾è¡¨æ ‡ç­¾ï¼‰
final_crash_buy = is_crash_buy  // CRASH BUY ä¸å—è¶‹åŠ¿è¿‡æ»¤é™åˆ¶
final_strong_buy = is_strong_buy  // STRONG BUY ä¸å—è¶‹åŠ¿è¿‡æ»¤é™åˆ¶
final_buy_dip = is_buy_dip and is_signal_allowed  // BUY DIP å—è¶‹åŠ¿è¿‡æ»¤

final_buy_signal = final_crash_buy or final_strong_buy or final_buy_dip
final_sell_signal = is_euphoria_sell or is_strong_sell or is_sell_hedge

// ========== 6. ä¿¡å·ç»Ÿè®¡ (v7.0 æ–°å¢) ==========
// è®¡ç®—ç»Ÿè®¡å›æœ›èŒƒå›´ï¼ˆæŒ‰å¹´ï¼Œæ—¥çº¿çº¦252æ ¹Kçº¿/å¹´ï¼‰
stats_lookback_bars = stats_lookback_years * 252
// ä¿®å¤ï¼šä½¿ç”¨ last_bar_index è®¡ç®—å›æœ›èŒƒå›´ï¼ˆç›¸å¯¹äºå›¾è¡¨æœ€åä¸€æ ¹Kçº¿ï¼‰
stats_start_bar = last_bar_index > stats_lookback_bars ? (last_bar_index - stats_lookback_bars) : 0
is_within_stats_range = bar_index >= stats_start_bar

// ä½¿ç”¨ var ç´¯ç§¯ç»Ÿè®¡å„çº§åˆ«ä¿¡å·æ¬¡æ•°
var int crash_buy_count = 0
var int strong_buy_count = 0
var int buy_dip_count = 0
var int sell_count = 0

// ç´¯ç§¯æ”¶ç›Šç»Ÿè®¡
var float crash_buy_return_sum = 0.0
var float strong_buy_return_sum = 0.0
var float buy_dip_return_sum = 0.0
var int crash_buy_return_count = 0
var int strong_buy_return_count = 0
var int buy_dip_return_count = 0

// æ¯æ¬¡é‡æ–°è®¡ç®—æ—¶é‡ç½®è®¡æ•°ï¼ˆå› ä¸º last_bar_index å˜åŒ–ä¼šæ”¹å˜èŒƒå›´ï¼‰
if barstate.isfirst
    crash_buy_count := 0
    strong_buy_count := 0
    buy_dip_count := 0
    sell_count := 0
    crash_buy_return_sum := 0.0
    strong_buy_return_sum := 0.0
    buy_dip_return_sum := 0.0
    crash_buy_return_count := 0
    strong_buy_return_count := 0
    buy_dip_return_count := 0

// ç»Ÿè®¡ä¿¡å·æ¬¡æ•°ï¼ˆä»…åœ¨å›æœ›èŒƒå›´å†…ï¼‰
if final_crash_buy and is_within_stats_range
    crash_buy_count += 1
if final_strong_buy and is_within_stats_range
    strong_buy_count += 1
if final_buy_dip and is_within_stats_range
    buy_dip_count += 1
if final_sell_signal and is_within_stats_range
    sell_count += 1

// è®¡ç®—ä¿¡å·ååˆ†çº§å›æŠ¥ï¼ˆä½¿ç”¨ SPX æ”¶ç›Šä½œä¸ºå‚è€ƒï¼‰
crash_spx_return = not na(spx_close) and not na(spx_close[crash_return_bars]) ? (spx_close - spx_close[crash_return_bars]) / spx_close[crash_return_bars] * 100 : 0.0
strong_spx_return = not na(spx_close) and not na(spx_close[strong_return_bars]) ? (spx_close - spx_close[strong_return_bars]) / spx_close[strong_return_bars] * 100 : 0.0
dip_spx_return = not na(spx_close) and not na(spx_close[dip_return_bars]) ? (spx_close - spx_close[dip_return_bars]) / spx_close[dip_return_bars] * 100 : 0.0

if final_crash_buy[crash_return_bars] and is_within_stats_range[crash_return_bars]
    crash_buy_return_sum += crash_spx_return
    crash_buy_return_count += 1
if final_strong_buy[strong_return_bars] and is_within_stats_range[strong_return_bars]
    strong_buy_return_sum += strong_spx_return
    strong_buy_return_count += 1
if final_buy_dip[dip_return_bars] and is_within_stats_range[dip_return_bars]
    buy_dip_return_sum += dip_spx_return
    buy_dip_return_count += 1

// è®¡ç®—å¹³å‡æ”¶ç›Š
crash_buy_avg_return = crash_buy_return_count > 0 ? crash_buy_return_sum / crash_buy_return_count : 0.0
strong_buy_avg_return = strong_buy_return_count > 0 ? strong_buy_return_sum / strong_buy_return_count : 0.0
buy_dip_avg_return = buy_dip_return_count > 0 ? buy_dip_return_sum / buy_dip_return_count : 0.0

// æœ€ç»ˆä¿¡å·ç¿»è¯‘
signal_txt = ""
signal_col = color.gray
signal_emoji = ""

if score >= 6
    signal_txt := "ğŸš¨ CRASH BUY"
    signal_col := color.new(#00FF00, 0)
    signal_emoji := "ğŸš¨"
else if score >= 5
    signal_txt := "STRONG BUY"
    signal_col := color.green
    signal_emoji := "ğŸŸ¢"
else if score >= min_score_buy
    signal_txt := "BUY DIP"
    signal_col := color.lime
    signal_emoji := "ğŸŸ¡"
else if score <= -6
    signal_txt := "ğŸ”¥ EUPHORIA SELL"
    signal_col := color.new(#FF0000, 0)
    signal_emoji := "ğŸ”¥"
else if score <= -5
    signal_txt := "STRONG SELL"
    signal_col := color.red
    signal_emoji := "ğŸ”´"
else if score <= -2
    signal_txt := "SELL/HEDGE"
    signal_col := color.orange
    signal_emoji := "ğŸŸ "
else
    signal_txt := "WAIT / HOLD"
    signal_col := color.gray
    signal_emoji := "âšª"

// ç†Šå¸‚ç‰¹æ®Šæç¤º
if use_trend_filter and not is_bull_market and score >= min_score_buy and score < 5
    signal_txt := "NO TRADE (Trend)"
    signal_col := color.gray
    signal_emoji := "ğŸš«"

// ========== 7. ç»˜å›¾ ==========
bgcolor(contango_pct > 0 ? color.new(color.green, 95) : color.new(color.red, 92))

col_z = z >= 0 ? color.from_gradient(z, 0, 3, color.new(color.blue, 40), color.new(color.blue, 10)) : 
                 color.from_gradient(z, -3, 0, color.new(color.red, 10), color.new(color.orange, 40))

plot(show_z ? z : na, color=col_z, title="Term Struct Z", linewidth=2)
plot(show_skew ? scaled_skew : na, color=color.new(color.fuchsia, 40), title="SKEW (Scaled)", linewidth=1)

hline(0, "Zero", color=color.gray, linestyle=hline.style_solid)
mid_hline_style = mid_line_style == "Solid" ? hline.style_solid : mid_line_style == "Dashed" ? hline.style_dashed : hline.style_dotted
hline(1, "+1 Mid", color=mid_line_color, linestyle=mid_hline_style)
hline(-1, "-1 Mid", color=mid_line_color, linestyle=mid_hline_style)
plot(thresh_strong, "Upper", color=color.new(color.gray, 50), style=plot.style_line)
plot(-thresh_strong, "Lower", color=color.new(color.gray, 50), style=plot.style_line)

// ä½¿ç”¨æ»šåŠ¨æœ€å¤§å€¼çš„æˆäº¤é‡å¯è§†åŒ–
scaled_vol = not na(vx1_vol) and vol_max_rolling > 0 ? ((vx1_vol * vol_visual_boost) / vol_max_rolling) * 1.8 - 3.8 : na
plot(show_volume ? scaled_vol : na, color=col_vol, title="Smart Volume", style=plot.style_columns, linewidth=2)

// ========== 8. ä¸‰çº§ä¿¡å·å›¾è¡¨æ ‡ç­¾ (v7.0 æ–°å¢) ==========
plotshape(final_crash_buy ? -thresh_strong - 0.3 : na, title="Crash Buy Signal", location=location.absolute, style=shape.labelup, color=color.new(#00FF00, 0), text="ğŸš¨", textcolor=color.white, size=size.small)
plotshape(final_strong_buy ? -thresh_strong - 0.3 : na, title="Strong Buy Signal", location=location.absolute, style=shape.labelup, color=color.new(color.green, 20), text="ğŸŸ¢", textcolor=color.white, size=size.tiny)
plotshape(final_buy_dip ? -thresh_strong - 0.3 : na, title="Buy Dip Signal", location=location.absolute, style=shape.labelup, color=color.new(color.lime, 20), text="ğŸŸ¡", textcolor=color.white, size=size.tiny)

plotshape(is_euphoria_sell ? thresh_strong + 0.3 : na, title="Euphoria Sell Signal", location=location.absolute, style=shape.labeldown, color=color.new(#FF0000, 0), text="ğŸ”¥", textcolor=color.white, size=size.small)
plotshape(is_strong_sell ? thresh_strong + 0.3 : na, title="Strong Sell Signal", location=location.absolute, style=shape.labeldown, color=color.new(color.red, 20), text="ğŸ”´", textcolor=color.white, size=size.tiny)
plotshape(is_sell_hedge ? thresh_strong + 0.3 : na, title="Sell/Hedge Signal", location=location.absolute, style=shape.labeldown, color=color.new(color.orange, 20), text="ğŸŸ ", textcolor=color.white, size=size.tiny)

// ========== 9. å¢å¼ºç‰ˆä»ªè¡¨ç›˜ (Compact/Full æ¨¡å¼) ==========
// Compact: 8 rows, Full: 15 rows max
panel_rows = is_compact ? 9 : (use_vvix ? 16 : 15)
var table panel = table.new(position.top_right, 2, panel_rows, border_width=0, frame_color=color.new(color.gray, 100), border_color=color.new(color.gray, 100))

if show_table and barstate.islast
    transp_header = math.max(0, bg_transp - 20)
    transp_cell   = bg_transp
    
    bg_header = color.new(color.black, transp_header) 
    bg_cell   = color.new(color.black, transp_cell)
    txt_lbl   = color.new(color.white, 10)

    mode_display = sens_mode == "High (Scalping)" ? "(High)" : sens_mode == "Normal (Swing)" ? "(Normal)" : "(Trend Guard)"
    table.cell(panel, 0, 0, "AI Signal " + mode_display, bgcolor=bg_header, text_color=color.white, text_size=t_size, width=12)
    table.cell(panel, 1, 0, is_compact ? "Compact" : "Full", bgcolor=bg_header, text_color=color.white, text_size=t_size, width=9)
    
    // Row 1: Overall Bias
    table.cell(panel, 0, 1, "Overall Bias", bgcolor=bg_cell, text_color=color.white, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 1, signal_txt, bgcolor=bg_cell, text_color=signal_col, text_size=t_size)

    // Row 2: AI Score
    score_col = score >= 5 ? color.green : score >= min_score_buy ? color.lime : score <= -5 ? color.red : score <= -2 ? color.orange : color.silver
    table.cell(panel, 0, 2, "AI Score", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 2, str.tostring(score, "#.#"), bgcolor=bg_cell, text_color=score_col, text_size=t_size)

    // Row 3: Market Trend (åŒæŒ‡æ•°åˆå¹¶æ˜¾ç¤º)
    table.cell(panel, 0, 3, "Market Trend", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 3, trend_status_txt, bgcolor=bg_cell, text_color=trend_color, text_size=t_size)

    // Row 4: VIX Regime
    table.cell(panel, 0, 4, "VIX Regime", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 4, vix_regime_txt + " (" + str.tostring(vix, "#.#") + ")", bgcolor=bg_cell, text_color=vix_regime_color, text_size=t_size)

    // Row 5: Term Struct Z
    z_col_t = z > thresh_strong ? color.new(color.blue, 20) : z < -thresh_strong ? color.new(color.red, 20) : color.silver
    table.cell(panel, 0, 5, "Term Struct Z", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 5, str.tostring(z, "#.##"), bgcolor=bg_cell, text_color=z_col_t, text_size=t_size)

    // Row 6: Vol Status
    vol_ratio = not na(vx1_vol) ? vx1_vol / vol_ma : 0
    vol_txt = vol_ratio > 2.5 ? "PANIC SPIKE" : vol_ratio > 1.5 ? "High Activity" : "Normal"
    vol_col_txt = vol_ratio > 2.5 ? color.yellow : vol_ratio > 1.5 ? color.aqua : color.silver
    table.cell(panel, 0, 6, "Vol Status", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 6, vol_txt, bgcolor=bg_cell, text_color=vol_col_txt, text_size=t_size)

    // Row 7: Z Momentum
    z_mom_txt = z_momentum_bullish ? "â†“ Falling" : z_momentum_bearish ? "â†‘ Rising" : "â†’ Flat"
    z_mom_col = z_momentum_bullish ? color.lime : z_momentum_bearish ? color.orange : color.silver
    table.cell(panel, 0, 7, "Z Momentum", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 7, z_mom_txt, bgcolor=bg_cell, text_color=z_mom_col, text_size=t_size)

    // Row 8: Signal Stats (v7.0 æ–°å¢)
    if show_signal_stats
        stats_txt = "ğŸš¨:" + str.tostring(crash_buy_count) + " ğŸŸ¢:" + str.tostring(strong_buy_count) + " ğŸŸ¡:" + str.tostring(buy_dip_count)
        table.cell(panel, 0, 8, "Signal Stats", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, 8, stats_txt, bgcolor=bg_cell, text_color=color.white, text_size=t_size)

    // ===== Full Mode Only =====
    if not is_compact
        base_row = show_signal_stats ? 9 : 8
        
        // Avg Return åˆ†çº§æ˜¾ç¤º (v7.1 æ–°å¢)
        if show_signal_stats
            // ç¬¬ä¸€è¡Œï¼šCRASH å’Œ STRONG
            avg_return_txt1 = "ğŸš¨" + str.tostring(crash_return_bars) + "D:" + str.tostring(crash_buy_avg_return, "+#.#;-#.#") + "% ğŸŸ¢" + str.tostring(strong_return_bars) + "D:" + str.tostring(strong_buy_avg_return, "+#.#;-#.#") + "%"
            table.cell(panel, 0, base_row, "Avg Return", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
            table.cell(panel, 1, base_row, avg_return_txt1, bgcolor=bg_cell, text_color=color.white, text_size=t_size)
            // ç¬¬äºŒè¡Œï¼šBUY DIP
            avg_return_txt2 = "ğŸŸ¡" + str.tostring(dip_return_bars) + "D:" + str.tostring(buy_dip_avg_return, "+#.#;-#.#") + "%"
            table.cell(panel, 0, base_row + 1, "", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
            table.cell(panel, 1, base_row + 1, avg_return_txt2, bgcolor=bg_cell, text_color=color.white, text_size=t_size)
            base_row += 2

        // VIX Basis
        basis_col = is_basis_panic ? color.red : is_basis_calm ? color.lime : color.silver
        basis_txt = str.tostring(vix_basis, "#.##") + "%"
        table.cell(panel, 0, base_row, "VIX Basis", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, base_row, basis_txt, bgcolor=bg_cell, text_color=basis_col, text_size=t_size)

        // Contango
        c_col = contango_pct > 0 ? color.lime : color.red
        table.cell(panel, 0, base_row + 1, "Contango %", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, base_row + 1, str.tostring(contango_pct, "#.##") + "%", bgcolor=bg_cell, text_color=c_col, text_size=t_size)

        // SKEW
        skew_val_str = not na(skew) ? str.tostring(skew, "#.0") : "N/A"
        skew_col_final = not na(skew) ? (is_skew_high ? color.red : is_skew_low ? color.lime : color.silver) : color.gray
        table.cell(panel, 0, base_row + 2, "SKEW Index", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, base_row + 2, skew_val_str, bgcolor=bg_cell, text_color=skew_col_final, text_size=t_size)

        // VVIX (if enabled)
        vvix_offset = 0
        if use_vvix
            vvix_val_str = not na(vvix) ? str.tostring(vvix, "#.#") : "N/A"
            vvix_col = is_vvix_panic ? color.red : is_vvix_calm ? color.lime : color.silver
            table.cell(panel, 0, base_row + 3, "VVIX", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
            table.cell(panel, 1, base_row + 3, vvix_val_str, bgcolor=bg_cell, text_color=vvix_col, text_size=t_size)
            vvix_offset := 1

        // P/C Ratio
        pcr_display = not na(pcr) ? str.tostring(pcr, "#.##") : "N/A"
        pcr_col = not na(pcr) ? (pcr > 1.2 ? color.lime : pcr < 0.7 ? color.red : color.silver) : color.gray
        table.cell(panel, 0, base_row + 3 + vvix_offset, "Put/Call (Idx)", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
        table.cell(panel, 1, base_row + 3 + vvix_offset, pcr_display, bgcolor=bg_cell, text_color=pcr_col, text_size=t_size)

// ========== 10. å¢å¼ºç‰ˆ Alerts (å¸¦å†·å´æœºåˆ¶) ==========
var int last_buy_alert_bar = 0
var int last_sell_alert_bar = 0
var int last_extreme_alert_bar = 0

// ä½¿ç”¨ alert() å‘é€åŠ¨æ€æ¶ˆæ¯ï¼ˆåŒ…å«å®æ—¶æ•°å€¼ï¼‰- å¸¦å†·å´
if final_crash_buy and (bar_index - last_extreme_alert_bar > alert_cooldown)
    alert("ğŸš¨ CRASH BUY! Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##") + " | Basis=" + str.tostring(vix_basis, "#.#") + "%", alert.freq_once_per_bar)
    last_extreme_alert_bar := bar_index

if final_strong_buy and (bar_index - last_buy_alert_bar > alert_cooldown)
    alert("ğŸŸ¢ STRONG BUY | Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##") + " | Contango=" + str.tostring(contango_pct, "#.#") + "%", alert.freq_once_per_bar)
    last_buy_alert_bar := bar_index

if final_buy_dip and (bar_index - last_buy_alert_bar > alert_cooldown)
    alert("ğŸŸ¡ BUY DIP | Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##") + " | Basis=" + str.tostring(vix_basis, "#.#") + "%", alert.freq_once_per_bar)
    last_buy_alert_bar := bar_index

if is_euphoria_sell and (bar_index - last_extreme_alert_bar > alert_cooldown)
    alert("ğŸ”¥ EUPHORIA SELL! Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##") + " | SKEW=" + str.tostring(skew, "#"), alert.freq_once_per_bar)
    last_extreme_alert_bar := bar_index

if is_strong_sell and (bar_index - last_sell_alert_bar > alert_cooldown)
    alert("ğŸ”´ STRONG SELL | Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##"), alert.freq_once_per_bar)
    last_sell_alert_bar := bar_index

if is_sell_hedge and (bar_index - last_sell_alert_bar > alert_cooldown)
    alert("ğŸŸ  SELL/HEDGE | Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##"), alert.freq_once_per_bar)
    last_sell_alert_bar := bar_index

// alertcondition ç”¨äºåˆ›å»ºè­¦æŠ¥ï¼ˆé™æ€æ¶ˆæ¯ï¼Œç”¨äº TradingView è­¦æŠ¥é¢æ¿ï¼‰
alertcondition(final_crash_buy, "ğŸš¨ Crash Buy Alert", "ğŸš¨ CRASH BUY: Score >= 6, extreme panic!")
alertcondition(final_strong_buy, "ğŸŸ¢ Strong Buy Alert", "ğŸŸ¢ STRONG BUY: Score >= 5, multi-factor confluence!")
alertcondition(final_buy_dip, "ğŸŸ¡ Buy Dip Alert", "ğŸŸ¡ BUY DIP: Score >= threshold, consider accumulating!")
alertcondition(is_euphoria_sell, "ğŸ”¥ Euphoria Sell Alert", "ğŸ”¥ EUPHORIA SELL: Score <= -6, extreme greed!")
alertcondition(is_strong_sell, "ğŸ”´ Strong Sell Alert", "ğŸ”´ STRONG SELL: Score <= -5, consider hedging!")
alertcondition(is_basis_panic, "ğŸ”¥ VIX Basis Panic", "ğŸ”¥ VIX Spot Premium > threshold, high fear detected!")