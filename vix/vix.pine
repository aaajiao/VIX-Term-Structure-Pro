//@version=5
indicator("VIX Term Structure Pro [v5.0 Enhanced]", overlay=false, max_lines_count=500)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    VIX Term Structure Pro v5.0 ä½¿ç”¨æŒ‡å—                      â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Š ä»ªè¡¨ç›˜æŒ‡æ ‡è§£è¯»                                                           â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ æŒ‡æ ‡           â”‚ çœ‹æ¶¨ä¿¡å· ğŸŸ¢              â”‚ çœ‹è·Œä¿¡å· ğŸ”´                     â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ Overall Bias   â”‚ STRONG BUY / BUY DIP    â”‚ STRONG SELL / SELL/HEDGE       â•‘
// â•‘ AI Score       â”‚ â‰¥ 5 (æåº¦ææ…Œ)           â”‚ â‰¤ -5 (æåº¦è´ªå©ª)                 â•‘
// â•‘ Market Trend   â”‚ BULL (Above MA200)      â”‚ BEAR (Below MA200)             â•‘
// â•‘ Term Struct Z  â”‚ < -2.0 (ææ…Œ)           â”‚ > 2.0 (è´ªå©ª)                    â•‘
// â•‘ VIX Basis      â”‚ > 5% (ç°è´§æº¢ä»·=ææ…Œ)     â”‚ < -3% (è´´æ°´=è¿‡äºå¹³é™)           â•‘
// â•‘ Contango %     â”‚ < 0% (å€’æŒ‚=ææ…Œ)        â”‚ > 10% (é™¡å³­=æ­£å¸¸)               â•‘
// â•‘ SKEW Index     â”‚ < 110 (æ— å°¾éƒ¨æ‹…å¿§)      â”‚ > 145 (æ‹…å¿ƒå´©ç›˜)                â•‘
// â•‘ Put/Call Ratio â”‚ > 1.2 (æåº¦æ‚²è§‚)        â”‚ < 0.7 (æåº¦ä¹è§‚)                â•‘
// â•‘ Vol Status     â”‚ PANIC SPIKE             â”‚ Normal                         â•‘
// â•‘ Z Momentum     â”‚ â†“ Falling (ææ…ŒåŠ å‰§)    â”‚ â†‘ Rising (è´ªå©ªåŠ å‰§)             â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ¯ AI Score è¯„åˆ†ç³»ç»Ÿ                                                        â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ Z < -2.5 (æä½)        â†’ +4 åˆ†    â”‚ Z > 2.5 (æé«˜)         â†’ -4 åˆ†        â•‘
// â•‘ Z < -1.5 (ä½)          â†’ +2 åˆ†    â”‚ Z > 1.5 (é«˜)           â†’ -2 åˆ†        â•‘
// â•‘ Contango < 0 (å€’æŒ‚)    â†’ +2 åˆ†    â”‚ Contango > 10%         â†’ -1 åˆ†        â•‘
// â•‘ VIX Basis > 5%         â†’ +2 åˆ†    â”‚ VIX Basis < -3%        â†’ -1 åˆ†        â•‘
// â•‘ PCR > 1.2              â†’ +2 åˆ†    â”‚ PCR < 0.7              â†’ -2 åˆ†        â•‘
// â•‘ SKEW ä½                â†’ +1 åˆ†    â”‚ SKEW é«˜                â†’ -3 åˆ†        â•‘
// â•‘ æˆäº¤é‡çˆ†å‘ + Zä½       â†’ +1 åˆ†    â”‚ ç†Šå¸‚è¿‡æ»¤å™¨ (å¼€å¯)      â†’ -2 åˆ†        â•‘
// â•‘ åŠ¨é‡ç¡®è®¤               â†’ +1 åˆ†    â”‚                                       â•‘
// â•‘ å‘¨çº¿å…±æŒ¯               â†’ +1 åˆ†    â”‚                                       â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Œ ä¿¡å·å«ä¹‰                                                                 â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ ğŸš¨ CRASH BUY      â”‚ Score â‰¥ 6  â”‚ æç«¯ææ…Œï¼ŒæŠ„åº•æœºä¼š                        â•‘
// â•‘ ğŸŸ¢ STRONG BUY     â”‚ Score â‰¥ 5  â”‚ å¤šå› å­å…±æŒ¯ï¼Œå¯å»ºä»“                        â•‘
// â•‘ ğŸŸ¡ BUY DIP        â”‚ Score â‰¥ 2-4â”‚ é€¢ä½å¸çº³ (é—¨æ§›å› æ¨¡å¼è€Œå¼‚)                 â•‘
// â•‘ âšª WAIT/HOLD      â”‚ Score -2~2 â”‚ è§‚æœ›ï¼Œç­‰å¾…æ›´æ˜ç¡®ä¿¡å·                      â•‘
// â•‘ ğŸŸ  SELL/HEDGE     â”‚ Score â‰¤ -2 â”‚ è€ƒè™‘å‡ä»“æˆ–å¯¹å†²                            â•‘
// â•‘ ğŸ”´ STRONG SELL    â”‚ Score â‰¤ -5 â”‚ å¤šå› å­å…±æŒ¯çœ‹ç©º                            â•‘
// â•‘ ğŸ”¥ EUPHORIA SELL  â”‚ Score â‰¤ -6 â”‚ æç«¯è´ªå©ªï¼Œè€ƒè™‘æ¸…ä»“                        â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ âš™ï¸ ç­–ç•¥æ¨¡å¼è¯´æ˜                                                             â•‘
// â•‘----------------------------------------------------------------------------â•‘
// â•‘ High (Scalping)   â”‚ æ•æ„Ÿåº¦æœ€é«˜ï¼Œé€‚åˆæ—¥å†…/çŸ­çº¿ï¼Œä¿¡å·é¢‘ç¹                    â•‘
// â•‘ Normal (Swing)    â”‚ ä¸­ç­‰æ•æ„Ÿåº¦ï¼Œé€‚åˆæ³¢æ®µäº¤æ˜“                               â•‘
// â•‘ Low (Trend/Safe)  â”‚ æœ€ä¿å®ˆï¼Œä»…æ•æ‰æç«¯ä¿¡å·ï¼Œå‡ä¿¡å·æœ€å°‘                     â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ========== 1. å‚æ•°è®¾ç½® ==========
grp_disp = "Display Settings"
show_z      = input.bool(true, "Show Term Struct Z-Score", group=grp_disp)
show_skew   = input.bool(false, "Show Scaled SKEW Line", group=grp_disp)
show_volume = input.bool(true, "Show Smart Volume", group=grp_disp)
show_table  = input.bool(true, "Show Dashboard", group=grp_disp)
table_size  = input.string("Normal", "Dashboard Text Size", options=["Small", "Normal", "Large"], group=grp_disp)
bg_transp   = input.int(70, "Dashboard Transparency", minval=0, maxval=100, group=grp_disp)

grp_sens = "âš ï¸ Strategy Mode (å…³é”®è®¾ç½®)"
sens_mode   = input.string("Low (Trend/Safe)", "Signal Sensitivity", options=["High (Scalping)", "Normal (Swing)", "Low (Trend/Safe)"], group=grp_sens)

// è¶‹åŠ¿è¿‡æ»¤å™¨
use_trend_filter = input.bool(true, "ğŸ›¡ï¸ SPX Trend Filter (MA200)", group=grp_sens, tooltip="If ON: 'BUY DIP' is DISABLED when SPX is below MA200.\nOnly 'STRONG BUY' (Crash) signals are allowed in Bear Markets.")
trend_src        = input.symbol("SP:SPX", "Trend Reference Symbol", group=grp_sens)

// æ–°å¢ï¼šåŠ¨é‡ç¡®è®¤
grp_confirm = "ğŸ¯ Signal Confirmation"
use_momentum_confirm = input.bool(true, "Use Momentum Confirmation", group=grp_confirm, tooltip="Require Z-Score momentum to confirm signals")
momentum_bars = input.int(3, "Momentum Lookback Bars", minval=1, maxval=10, group=grp_confirm)
use_mtf_confirm = input.bool(false, "Use Weekly MTF Confirmation", group=grp_confirm, tooltip="Require weekly Z-Score alignment for strongest signals")

// ä¼˜åŒ–ï¼šä½¿ç”¨æ¡ä»¶è¡¨è¾¾å¼ç›´æ¥è®¾ç½®å‚æ•°ï¼ˆç¼–è¯‘æœŸä¼˜åŒ–ï¼‰
smooth_dyn = sens_mode == "High (Scalping)" ? 3 : sens_mode == "Normal (Swing)" ? 5 : 8
thresh_strong = sens_mode == "High (Scalping)" ? 2.0 : sens_mode == "Normal (Swing)" ? 2.2 : 2.5
thresh_mid = sens_mode == "High (Scalping)" ? 1.0 : sens_mode == "Normal (Swing)" ? 1.2 : 1.5
min_score_buy = sens_mode == "High (Scalping)" ? 2 : sens_mode == "Normal (Swing)" ? 3 : 4

// --- åŸºç¡€ç»Ÿè®¡ ---
grp_stat = "Advanced Settings"
use_adaptive = input.bool(true, "Use Adaptive Lookback", group=grp_stat)
len_low      = input.int(252, "Lookback (Low Vol)", minval=50, group=grp_stat)
len_high     = input.int(126, "Lookback (High Vol)", minval=20, group=grp_stat)
vol_thresh   = input.float(20.0, "Vol Regime Threshold", minval=10, group=grp_stat)
vol_avg_len  = input.int(20, "Volume Avg Length", minval=5, group=grp_stat)
skew_mode    = input.string("Relative (Z-Score)", "SKEW Logic Mode", options=["Relative (Z-Score)", "Percentile (Adaptive)", "Absolute (>140)"], group=grp_stat)
skew_len     = input.int(126, "SKEW Lookback Period", minval=20, group=grp_stat)
sym_pcr_input = input.symbol("CBOE:CPCI", "Put/Call Ratio Symbol", group="Data Symbols")

t_size = table_size == "Small" ? size.small : table_size == "Large" ? size.large : size.normal

// ========== 2. æ•°æ®è·å– ==========
vix     = request.security("CBOE:VIX", "D", close, ignore_invalid_symbol=true)
vx1     = request.security("CBOE:VX1!", "D", close, ignore_invalid_symbol=true)
vx2     = request.security("CBOE:VX2!", "D", close, ignore_invalid_symbol=true)
vx1_vol = request.security("CBOE:VX1!", "D", volume, ignore_invalid_symbol=true)
skew    = request.security("CBOE:SKEW", "D", close, ignore_invalid_symbol=true)
pcr     = request.security(sym_pcr_input, "D", close, ignore_invalid_symbol=true)

// è·å–å¤§ç›˜è¶‹åŠ¿æ•°æ® (SPX)
spx_close = request.security(trend_src, "D", close, ignore_invalid_symbol=true)
spx_ma200 = request.security(trend_src, "D", ta.sma(close, 200), ignore_invalid_symbol=true)

valid_data = not na(vix) and not na(vx1) and not na(vx2)

// ========== 3. æ ¸å¿ƒè®¡ç®— ==========
// Trend Filter Logic
is_bull_market = not na(spx_close) ? (spx_close > spx_ma200) : true
trend_status_txt = is_bull_market ? "BULL (Above MA200)" : "BEAR (Below MA200)"
trend_color = is_bull_market ? color.green : color.red

term_spread = valid_data ? (vx2 - vx1) : 0.0
contango_pct = valid_data and vx1 != 0 ? ((vx2 / vx1) - 1) * 100 : 0.0

// æ–°å¢ï¼šVIX/VX1 Basisï¼ˆç°è´§æº¢ä»·ï¼‰- ææ…Œé¢†å…ˆæŒ‡æ ‡
vix_basis = valid_data and vx1 != 0 ? ((vix / vx1) - 1) * 100 : 0.0
is_basis_panic = vix_basis > 5    // ç°è´§å¤§å¹…æº¢ä»· = æåº¦ææ…Œ
is_basis_calm  = vix_basis < -3   // ç°è´§è´´æ°´ = å¸‚åœºå¹³é™

is_high_vol = valid_data and (vix > vol_thresh)
lookback    = use_adaptive ? (is_high_vol ? len_high : len_low) : len_low
avg   = ta.sma(term_spread, lookback)
stdev = ta.stdev(term_spread, lookback)
raw_z = (valid_data and stdev != 0) ? (term_spread - avg) / stdev : 0.0
z     = ta.ema(raw_z, smooth_dyn)

// æ–°å¢ï¼šZ-Score åŠ¨é‡ï¼ˆå˜åŒ–ç‡ï¼‰
z_roc = z - z[momentum_bars]
z_momentum_bullish = z_roc < 0  // Z åœ¨ä¸‹é™ï¼ˆææ…ŒåŠ å‰§ï¼‰
z_momentum_bearish = z_roc > 0  // Z åœ¨ä¸Šå‡ï¼ˆè´ªå©ªåŠ å‰§ï¼‰

// æ–°å¢ï¼šå‘¨çº¿ MTF ç¡®è®¤
z_weekly = request.security(syminfo.tickerid, "W", z, ignore_invalid_symbol=true)
is_weekly_buy_aligned = not na(z_weekly) ? z_weekly < -thresh_mid : true
is_weekly_sell_aligned = not na(z_weekly) ? z_weekly > thresh_mid : true

// Smart SKEW - ä¼˜åŒ–ï¼šæ”¯æŒç™¾åˆ†ä½æ•°æ¨¡å¼
skew_avg   = ta.sma(skew, skew_len)
skew_stdev = ta.stdev(skew, skew_len)
skew_z     = (skew - skew_avg) / skew_stdev

// æ–°å¢ï¼šSKEW ç™¾åˆ†ä½æ•°è®¡ç®—ï¼ˆæ›´è‡ªé€‚åº”ï¼‰
skew_pct_high = ta.percentile_linear_interpolation(skew, 252, 90)
skew_pct_low  = ta.percentile_linear_interpolation(skew, 252, 10)

skew_trig_high = sens_mode == "High (Scalping)" ? 1.5 : 1.8 

// æ ¹æ®æ¨¡å¼é€‰æ‹© SKEW åˆ¤æ–­é€»è¾‘
is_skew_high = skew_mode == "Relative (Z-Score)" ? (skew_z > skew_trig_high) : 
               skew_mode == "Percentile (Adaptive)" ? (skew > skew_pct_high) : 
               (skew > 145)
is_skew_low  = skew_mode == "Relative (Z-Score)" ? (skew_z < -1.5) : 
               skew_mode == "Percentile (Adaptive)" ? (skew < skew_pct_low) : 
               (skew < 110)
scaled_skew = not na(skew) ? (skew - 100) / 10 : na

// Smart Volume
vol_ma = ta.sma(vx1_vol, vol_avg_len)
is_vol_spike  = vx1_vol >= vol_ma * 2.5 
is_vol_high   = vx1_vol >= vol_ma * 1.5 
col_vol = is_vol_spike ? color.new(color.yellow, 30) : is_vol_high ? color.new(color.aqua, 60) : color.new(color.gray, 90)
vol_visual_boost = is_vol_spike ? 1.2 : 1.0 

// ========== 4. AI ä¿¡å·ç®—æ³• (Enhanced v5.0) ==========
var float score = 0.0
score := 0.0

// (1) Z-Score åŸºç¡€åˆ†
if z < -thresh_strong
    score := score + 4 
else if z < -thresh_mid
    score := score + 2 
else if z > thresh_strong
    score := score - 4
else if z > thresh_mid
    score := score - 2

// (2) Contango/Backwardation
if contango_pct < 0
    score := score + 2
else if contango_pct > 10
    score := score - 1

// (3) æ–°å¢ï¼šVIX Basisï¼ˆç°è´§æº¢ä»·ï¼‰
if is_basis_panic
    score := score + 2  // ç°è´§å¤§å¹…æº¢ä»· = ææ…Œä¿¡å·
else if is_basis_calm
    score := score - 1  // ç°è´§è´´æ°´ = å¸‚åœºè¿‡äºå¹³é™

// (4) SKEW
if not na(skew)
    if is_skew_high
        score := score - 3
    else if is_skew_low
        score := score + 1

// (5) P/C Ratio
if not na(pcr)
    if pcr > 1.20
        score := score + 2
    else if pcr < 0.70
        score := score - 2

// (6) Vol Resonance
if is_vol_spike and z < -thresh_mid
    score := score + 1

// (7) æ–°å¢ï¼šåŠ¨é‡ç¡®è®¤åŠ åˆ†
if use_momentum_confirm
    if z < -thresh_mid and z_momentum_bullish  // Z ä½ä½ä¸”è¿˜åœ¨ä¸‹é™
        score := score + 1
    else if z > thresh_mid and z_momentum_bearish  // Z é«˜ä½ä¸”è¿˜åœ¨ä¸Šå‡
        score := score - 1

// (8) æ–°å¢ï¼šMTF ç¡®è®¤åŠ åˆ†
if use_mtf_confirm
    if z < -thresh_mid and is_weekly_buy_aligned
        score := score + 1  // æ—¥çº¿+å‘¨çº¿å…±æŒ¯
    else if z > thresh_mid and is_weekly_sell_aligned
        score := score - 1

// --- ğŸ›¡ï¸ è¶‹åŠ¿è¿‡æ»¤é€»è¾‘ ---
if use_trend_filter and not is_bull_market
    score := score - 2 

// æœ€ç»ˆä¿¡å·ç¿»è¯‘
signal_txt = ""
signal_col = color.gray
signal_emoji = ""

if score >= 6
    signal_txt := "ğŸš¨ CRASH BUY"
    signal_col := color.new(#00FF00, 0)
    signal_emoji := "ğŸš¨"
else if score >= 5
    signal_txt := "STRONG BUY"
    signal_col := color.green
    signal_emoji := "ğŸŸ¢"
else if score >= min_score_buy
    signal_txt := "BUY DIP"
    signal_col := color.lime
    signal_emoji := "ğŸŸ¡"
else if score <= -6
    signal_txt := "ğŸ”¥ EUPHORIA SELL"
    signal_col := color.new(#FF0000, 0)
    signal_emoji := "ğŸ”¥"
else if score <= -5
    signal_txt := "STRONG SELL"
    signal_col := color.red
    signal_emoji := "ğŸ”´"
else if score <= -2
    signal_txt := "SELL/HEDGE"
    signal_col := color.orange
    signal_emoji := "ğŸŸ "
else
    signal_txt := "WAIT / HOLD"
    signal_col := color.gray
    signal_emoji := "âšª"

// ç†Šå¸‚ç‰¹æ®Šæç¤º
if use_trend_filter and not is_bull_market and score >= min_score_buy and score < 5
    signal_txt := "NO TRADE (Trend)"
    signal_col := color.gray
    signal_emoji := "ğŸš«"

// ========== 5. ç»˜å›¾ ==========
bgcolor(contango_pct > 0 ? color.new(color.green, 95) : color.new(color.red, 92))

col_z = z >= 0 ? color.from_gradient(z, 0, 3, color.new(color.blue, 40), color.new(color.blue, 10)) : 
                 color.from_gradient(z, -3, 0, color.new(color.red, 10), color.new(color.orange, 40))

plot(show_z ? z : na, color=col_z, title="Term Struct Z", linewidth=2)
plot(show_skew ? scaled_skew : na, color=color.new(color.fuchsia, 40), title="SKEW (Scaled)", linewidth=1)

hline(0, "Zero", color=color.gray, linestyle=hline.style_solid)
plot(thresh_strong, "Upper", color=color.new(color.gray, 50), style=plot.style_line)
plot(-thresh_strong, "Lower", color=color.new(color.gray, 50), style=plot.style_line)

var float vol_max_static = 100000.0
if not na(vx1_vol)
    vol_max_static := math.max(vol_max_static, vx1_vol)
scaled_vol = not na(vx1_vol) ? ((vx1_vol * vol_visual_boost) / vol_max_static) * 1.8 - 3.8 : na
plot(show_volume ? scaled_vol : na, color=col_vol, title="Smart Volume", style=plot.style_columns, linewidth=2)

// ========== 6. å¢å¼ºç‰ˆä»ªè¡¨ç›˜ ==========
var table panel = table.new(position.top_right, 2, 11, border_width=0, frame_color=color.new(color.gray, 100), border_color=color.new(color.gray, 100))

if show_table and barstate.islast
    transp_header = math.max(0, bg_transp - 20)
    transp_cell   = bg_transp
    
    bg_header = color.new(color.black, transp_header) 
    bg_cell   = color.new(color.black, transp_cell)
    txt_lbl   = color.new(color.white, 10)

    mode_display = sens_mode == "High (Scalping)" ? "(High)" : sens_mode == "Normal (Swing)" ? "(Normal)" : "(Trend Guard)"
    table.cell(panel, 0, 0, "AI Signal " + mode_display, bgcolor=bg_header, text_color=color.white, text_size=t_size, width=12)
    table.cell(panel, 1, 0, "Status", bgcolor=bg_header, text_color=color.white, text_size=t_size, width=9)
    
    // 1. Overall Bias
    table.cell(panel, 0, 1, "Overall Bias", bgcolor=bg_cell, text_color=color.white, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 1, signal_txt, bgcolor=bg_cell, text_color=signal_col, text_size=t_size)

    // 2. æ–°å¢ï¼šAI Score æ˜¾ç¤º
    score_col = score >= 5 ? color.green : score >= min_score_buy ? color.lime : score <= -5 ? color.red : score <= -2 ? color.orange : color.silver
    table.cell(panel, 0, 2, "AI Score", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 2, str.tostring(score, "#.#"), bgcolor=bg_cell, text_color=score_col, text_size=t_size)

    // 3. Trend Filter Status
    table.cell(panel, 0, 3, "Market Trend", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 3, trend_status_txt, bgcolor=bg_cell, text_color=trend_color, text_size=t_size)

    // 4. Term Struct Z
    z_col_t = z > thresh_strong ? color.new(color.blue, 20) : z < -thresh_strong ? color.new(color.red, 20) : color.silver
    table.cell(panel, 0, 4, "Term Struct Z", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 4, str.tostring(z, "#.##"), bgcolor=bg_cell, text_color=z_col_t, text_size=t_size)

    // 5. æ–°å¢ï¼šVIX Basis
    basis_col = is_basis_panic ? color.red : is_basis_calm ? color.lime : color.silver
    basis_txt = str.tostring(vix_basis, "#.##") + "%"
    table.cell(panel, 0, 5, "VIX Basis", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 5, basis_txt, bgcolor=bg_cell, text_color=basis_col, text_size=t_size)

    // 6. Contango
    c_col = contango_pct > 0 ? color.lime : color.red
    table.cell(panel, 0, 6, "Contango %", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 6, str.tostring(contango_pct, "#.##") + "%", bgcolor=bg_cell, text_color=c_col, text_size=t_size)

    // 7. SKEW
    skew_val_str = not na(skew) ? str.tostring(skew, "#.0") : "N/A"
    skew_col_final = not na(skew) ? (is_skew_high ? color.red : is_skew_low ? color.lime : color.silver) : color.gray
    table.cell(panel, 0, 7, "SKEW Index", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 7, skew_val_str, bgcolor=bg_cell, text_color=skew_col_final, text_size=t_size)

    // 8. P/C Ratio
    pcr_display = not na(pcr) ? str.tostring(pcr, "#.##") : "N/A"
    pcr_col = not na(pcr) ? (pcr > 1.2 ? color.lime : pcr < 0.7 ? color.red : color.silver) : color.gray
    table.cell(panel, 0, 8, "Put/Call (Idx)", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 8, pcr_display, bgcolor=bg_cell, text_color=pcr_col, text_size=t_size)

    // 9. Vol Status
    vol_ratio = not na(vx1_vol) ? vx1_vol / vol_ma : 0
    vol_txt = vol_ratio > 2.5 ? "PANIC SPIKE" : vol_ratio > 1.5 ? "High Activity" : "Normal"
    vol_col_txt = vol_ratio > 2.5 ? color.yellow : vol_ratio > 1.5 ? color.aqua : color.silver
    table.cell(panel, 0, 9, "Vol Status", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 9, vol_txt, bgcolor=bg_cell, text_color=vol_col_txt, text_size=t_size)

    // 10. æ–°å¢ï¼šZ Momentum
    z_mom_txt = z_momentum_bullish ? "â†“ Falling" : z_momentum_bearish ? "â†‘ Rising" : "â†’ Flat"
    z_mom_col = z_momentum_bullish ? color.lime : z_momentum_bearish ? color.orange : color.silver
    table.cell(panel, 0, 10, "Z Momentum", bgcolor=bg_cell, text_color=txt_lbl, text_halign=text.align_left, text_size=t_size)
    table.cell(panel, 1, 10, z_mom_txt, bgcolor=bg_cell, text_color=z_mom_col, text_size=t_size)

// ========== 7. å¢å¼ºç‰ˆä¿¡å· ==========
is_signal_allowed = use_trend_filter ? is_bull_market : true

// åŠ¨é‡ç¡®è®¤è¿‡æ»¤
momentum_buy_ok = use_momentum_confirm ? z_momentum_bullish : true
momentum_sell_ok = use_momentum_confirm ? z_momentum_bearish : true

// MTF ç¡®è®¤è¿‡æ»¤
mtf_buy_ok = use_mtf_confirm ? is_weekly_buy_aligned : true
mtf_sell_ok = use_mtf_confirm ? is_weekly_sell_aligned : true

plot_buy = sens_mode == "Low (Trend/Safe)" ? ta.crossunder(z, -thresh_strong) : ta.crossunder(z, -thresh_mid)
plot_sell = sens_mode == "Low (Trend/Safe)" ? ta.crossover(z, thresh_strong) : ta.crossover(z, thresh_mid)

// ç»¼åˆè¿‡æ»¤åçš„ä¿¡å·
final_buy_signal = plot_buy and is_signal_allowed and momentum_buy_ok and mtf_buy_ok
final_sell_signal = plot_sell and momentum_sell_ok and mtf_sell_ok

plotshape(final_buy_signal ? -thresh_strong - 0.3 : na, title="Buy Signal", location=location.absolute, style=shape.labelup, color=color.new(color.green, 20), text="BUY", textcolor=color.new(color.white, 10), size=size.tiny)
plotshape(final_sell_signal ? thresh_strong + 0.3 : na, title="Sell Signal", location=location.absolute, style=shape.labeldown, color=color.new(color.red, 20), text="SELL", textcolor=color.new(color.white, 10), size=size.tiny)

// ========== 8. å¢å¼ºç‰ˆ Alerts ==========
// ä½¿ç”¨ alert() å‘é€åŠ¨æ€æ¶ˆæ¯ï¼ˆåŒ…å«å®æ—¶æ•°å€¼ï¼‰
if final_buy_signal
    alert("ğŸŸ¢ VIX Buy Signal | Z=" + str.tostring(z, "#.##") + " | Score=" + str.tostring(score, "#") + " | Contango=" + str.tostring(contango_pct, "#.#") + "% | Basis=" + str.tostring(vix_basis, "#.#") + "%", alert.freq_once_per_bar)

if final_sell_signal
    alert("ğŸ”´ VIX Sell Signal | Z=" + str.tostring(z, "#.##") + " | Score=" + str.tostring(score, "#") + " | Contango=" + str.tostring(contango_pct, "#.#") + "% | SKEW=" + str.tostring(skew, "#"), alert.freq_once_per_bar)

if score >= 6
    alert("ğŸš¨ CRASH BUY! Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##") + " | Basis=" + str.tostring(vix_basis, "#.#") + "%", alert.freq_once_per_bar)

if score <= -6
    alert("ğŸ”¥ EUPHORIA SELL! Score=" + str.tostring(score, "#") + " | Z=" + str.tostring(z, "#.##") + " | SKEW=" + str.tostring(skew, "#"), alert.freq_once_per_bar)

if is_basis_panic
    alert("âš ï¸ VIX Basis Panic! Spot Premium=" + str.tostring(vix_basis, "#.#") + "%", alert.freq_once_per_bar)

// alertcondition ç”¨äºåˆ›å»ºè­¦æŠ¥ï¼ˆé™æ€æ¶ˆæ¯ï¼Œç”¨äº TradingView è­¦æŠ¥é¢æ¿ï¼‰
alertcondition(final_buy_signal, "Smart Buy Signal", "VIX Term Structure triggered a BUY signal. Check chart for details.")
alertcondition(final_sell_signal, "Smart Sell Signal", "VIX Term Structure triggered a SELL signal. Check chart for details.")
alertcondition(score >= 6, "Crash Buy Alert", "EXTREME PANIC: Score >= 6, potential crash buying opportunity!")
alertcondition(score <= -6, "Euphoria Sell Alert", "EXTREME EUPHORIA: Score <= -6, consider hedging!")
alertcondition(is_basis_panic, "VIX Basis Panic", "VIX Spot Premium > 5%, high fear detected!")